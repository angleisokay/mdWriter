<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markdown Editor</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  /* OpenDyslexic Font Faces */
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Regular.otf') format('opentype');
    font-weight: normal;
    font-style: normal;
  }
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold.otf') format('opentype');
    font-weight: bold;
    font-style: normal;
  }
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Italic.otf') format('opentype');
    font-weight: normal;
    font-style: italic;
  }
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold-Italic.otf') format('opentype');
    font-weight: bold;
    font-style: italic;
  }

  :root {
    --editor-font: 'OpenDyslexic', Arial, sans-serif;
    --editor-font-size: 1.1rem;
    --editor-line-height: 1.6;
    --editor-letter-spacing: 0.04em;
    --text-color: #181818;
  }

  body {
    margin: 0;
    font-family: var(--editor-font);
    background: #f9f9fb;
    color: var(--text-color);
    transition: background 0.2s, color 0.2s;
  }

  .app-container {
    display: flex;
    height: 100vh;
  }

  /* --- Options Button --- */
  .options-btn {
    position: absolute;
    left: 1rem;
    top: 1rem;
    width: 42px;
    height: 42px;
    border: none;
    background: #fff;
    border-radius: 50%; /* Ensures circular shape */
    box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: background 0.2s, box-shadow 0.2s;
    padding: 0;
  }
  .options-btn i {
    font-size: 1.6rem;
    margin: 0;
    padding: 0;
  }
  .options-btn:active {
    background: #eee;
  }

  /* --- Options Panel --- */
  .options-panel {
    position: absolute;
    left: 0;
    top: 0;
    width: 340px;
    height: 100%;
    background: #fff;
    border-right: 1px solid #eee;
    transform: translateX(-360px);
    transition: transform 0.2s cubic-bezier(.4,0,.2,1);
    z-index: 90;
    box-shadow: 2px 0 12px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .options-panel.open {
    transform: translateX(0);
  }
  .options-header {
    padding: 1.2rem 1.5rem 0.8rem 1.5rem;
    border-bottom: 1px solid #f0f0f0;
  }
  .options-header h3 { margin: 0; }

  .options-content { padding: 1rem 1.5rem; }
  .option-group { margin-bottom: 1.5rem; }
  .option-label { display: block; font-size: 1rem; margin-bottom: 0.5rem; font-weight: bold; }

  .option-control, .zoom-slider {
    width: 100%;
    padding: 0.3rem 0.5rem;
    font-size: 1rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    outline: none;
    margin-bottom: 0.2rem;
  }

  .btn.primary {
    background: #2679e8;
    color: #fff;
    border: none;
    padding: 0.6rem 1.4rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
  }
  .btn.primary:hover { background: #1656b7; }

  /* --- Drafts Section --- */
  .drafts-list {
    max-height: 18rem;
    overflow-y: auto;
    border: 1px solid #f0f0f0;
    border-radius: 6px;
    background: #fafaff;
    padding: 0.25rem;
  }
  .draft-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0.9rem;
    border-radius: 6px;
    margin-bottom: 0.25rem;
    background: #fff;
    cursor: pointer;
    border: 1px solid transparent;
    user-select: none;
    transition: box-shadow 0.15s, border 0.15s, background 0.1s;
  }
  .draft-item.active {
    border: 1.5px solid #2679e8;
    background: #eaf2ff;
  }
  .draft-item.dragging {
    opacity: 0.5;
    background: #d5e4fa;
  }
  .draft-item.drag-over {
    border: 1.5px dashed #2679e8;
  }
  .draft-info {
    flex: 1;
  }
  .draft-title { font-weight: bold; }
  .draft-date { font-size: 0.8em; color: #888; }
  .draft-delete {
    background: none;
    border: none;
    color: #e04848;
    font-size: 1.2em;
    margin-left: 0.7em;
    cursor: pointer;
    display: flex;
    align-items: center;
  }

  /* --- Editor --- */
  .editor-container {
    flex: 1;
    min-width: 0;
    padding: 3.5rem 1.5rem 1.5rem 370px;
    transition: padding-left 0.2s;
    height: 100vh;
    box-sizing: border-box;
  }
  .options-panel:not(.open) ~ .editor-container {
    padding-left: 2rem;
  }
  .editor-content {
    min-height: 70vh;
    background: #fff;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 4px 24px rgba(0,0,0,0.03);
    font-family: var(--editor-font);
    font-size: var(--editor-font-size);
    line-height: var(--editor-line-height);
    letter-spacing: var(--editor-letter-spacing);
    color: var(--text-color);
    outline: none;
    transition: font-family 0.2s, font-size 0.2s, color 0.2s;
    word-break: break-word;
    /* Prevent font scaling glitches */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    resize: vertical;
    overflow: auto;
  }
  .editor-content[contenteditable="true"]:empty:before {
    content: 'Start writing your draft...';
    opacity: 0.4;
    pointer-events: none;
    font-style: italic;
    color: #8e8e8e;
  }

  /* --- Formatting Toolbar --- */
  .formatting-toolbar {
    position: absolute;
    display: none;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.11);
    padding: 0.3rem 0.4rem;
    z-index: 1001;
    gap: 0.3rem;
    top: 0;
    left: 0;
    flex-wrap: nowrap;
  }
  .formatting-toolbar button {
    background: none;
    border: none;
    font-size: 1.15rem;
    padding: 0.25rem 0.35rem;
    border-radius: 4px;
    cursor: pointer;
    color: #444;
    transition: background 0.12s;
  }
  .formatting-toolbar button:hover {
    background: #eaf2ff;
    color: #2679e8;
  }

  /* --- Modal --- */
  .modal {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    display: none;
    background: rgba(0,0,0,0.16);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: #fff;
    border-radius: 10px;
    padding: 2.5rem 2.2rem 2rem 2.2rem;
    box-shadow: 0 6px 32px rgba(0,0,0,0.11);
    min-width: 320px;
    text-align: center;
  }
  .modal-buttons {
    margin-top: 1.4rem;
    display: flex;
    justify-content: center;
    gap: 1.1rem;
  }
  .confirm-btn, .cancel-btn {
    padding: 0.6rem 1.4rem;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    cursor: pointer;
  }
  .confirm-btn { background: #2679e8; color: #fff; }
  .cancel-btn { background: #eaeaea; color: #222; }

  /* Color Picker */
  .color-picker {
    display: flex;
    align-items: center;
    gap: 0.6em;
  }
  .color-picker input[type="color"] {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: none;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }

  /* Toggle Switch */
  .switch {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  .switch input { display: none; }
  .slider {
    width: 42px;
    height: 22px;
    background: #e0e0e0;
    border-radius: 22px;
    position: relative;
    margin-right: 0.6em;
    transition: background 0.2s;
  }
  .slider:before {
    content: "";
    position: absolute;
    width: 18px;
    height: 18px;
    left: 2px;
    top: 2px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    transition: transform 0.2s;
  }
  input:checked + .slider { background: #2679e8; }
  input:checked + .slider:before {
    transform: translateX(20px);
  }

  /* --- Fixes for font rendering & italics --- */
  .editor-content, .editor-content * {
    font-family: var(--editor-font);
    font-size: inherit;
    line-height: inherit;
    letter-spacing: inherit;
    color: inherit;
    /* Fix for italic/bold/italic-bold */
    font-style: inherit !important;
    font-weight: inherit !important;
  }
  .editor-content em, .editor-content i {
    font-style: italic !important;
    font-family: var(--editor-font) !important;
  }
  .editor-content strong, .editor-content b {
    font-weight: bold !important;
    font-family: var(--editor-font) !important;
  }
  .editor-content em strong, .editor-content strong em, .editor-content b i, .editor-content i b {
    font-style: italic !important;
    font-weight: bold !important;
    font-family: var(--editor-font) !important;
  }
</style>
</head>
<body>
<div class="app-container">
  <button class="options-btn" id="optionsBtn">
    <i class="fas fa-cog"></i>
  </button>
  <div class="options-panel" id="optionsPanel">
    <div class="options-header">
      <h3>Settings</h3>
    </div>
    <div class="options-content">
      <div class="option-group">
        <label class="option-label">Draft Title (Optional)</label>
        <input type="text" class="option-control" id="draftTitle" placeholder="Leave empty to auto-generate from content">
      </div>
      <div class="option-group">
        <label class="option-label">Text Size</label>
        <div class="zoom-control">
          <span>Small</span>
          <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="200" value="100">
          <span class="zoom-value" id="zoomValue">100%</span>
        </div>
      </div>
      <div class="option-group">
        <label class="option-label">Text Color</label>
        <div class="color-picker">
          <input type="color" id="colorPicker" value="#181818">
          <span id="colorValue">#181818</span>
        </div>
      </div>
      <div class="option-group">
        <label class="option-label">OpenDyslexic Font</label>
        <label class="switch">
          <input type="checkbox" id="openDyslexicToggle" checked>
          <span class="slider"></span>
          <span id="fontToggleLabel">Enabled</span>
        </label>
      </div>
      <div class="option-group">
        <button class="btn primary" id="newDraft">New Draft</button>
      </div>
      <div class="option-group drafts-section">
        <label class="option-label">Drafts</label>
        <div class="drafts-list" id="draftsList"></div>
      </div>
    </div>
  </div>
  <div class="editor-container">
    <div class="editor-content" id="editor" contenteditable="true"></div>
  </div>
</div>
<div id="formattingToolbar" class="formatting-toolbar">
  <button data-format="bold"><i class="fas fa-bold"></i></button>
  <button data-format="italic"><i class="fas fa-italic"></i></button>
  <button data-format="h1">H1</button>
  <button data-format="h2">H2</button>
  <button data-format="h3">H3</button><!-- NEW H3 button -->
  <button data-format="blockquote"><i class="fas fa-quote-right"></i></button>
  <button data-format="code"><i class="fas fa-code"></i></button>
  <button data-format="link"><i class="fas fa-link"></i></button>
</div>
<div id="confirmationModal" class="modal">
  <div class="modal-content">
    <p id="modalMessage">Are you sure?</p>
    <div class="modal-buttons">
      <button class="confirm-btn" id="modalConfirmBtn">Confirm</button>
      <button class="cancel-btn" id="modalCancelBtn">Cancel</button>
    </div>
  </div>
</div>
<script>
class LiveMarkdownEditor {
  constructor() {
    this.drafts = [];
    this.currentDraftId = null;
    this.autoSaveTimer = null;
    this.localStorageKey = 'markdownEditorDrafts';
    this.initElements();
    this.bindEvents();
    this.loadDraftsFromLocalStorage();
    this.applySettingsFromLocalStorage();
    this.renderDrafts();
    this.setEditorStyles();
  }
  initElements() {
    this.editor = document.getElementById('editor');
    this.optionsPanel = document.getElementById('optionsPanel');
    this.draftsList = document.getElementById('draftsList');
    this.draftTitle = document.getElementById('draftTitle');
    this.optionsBtn = document.getElementById('optionsBtn');
    this.zoomSlider = document.getElementById('zoomSlider');
    this.zoomValue = document.getElementById('zoomValue');
    this.newDraftBtn = document.getElementById('newDraft');
    this.formattingToolbar = document.getElementById('formattingToolbar');
    this.confirmationModal = document.getElementById('confirmationModal');
    this.modalMessage = document.getElementById('modalMessage');
    this.modalConfirmBtn = document.getElementById('modalConfirmBtn');
    this.modalCancelBtn = document.getElementById('modalCancelBtn');
    this.colorPicker = document.getElementById('colorPicker');
    this.colorValue = document.getElementById('colorValue');
    this.openDyslexicToggle = document.getElementById('openDyslexicToggle');
    this.fontToggleLabel = document.getElementById('fontToggleLabel');
  }
  bindEvents() {
    document.addEventListener('click', (e) => {
      if (!this.optionsPanel.contains(e.target) && !this.optionsBtn.contains(e.target)) {
        this.optionsPanel.classList.remove('open');
        this.optionsBtn.innerHTML = '<i class="fas fa-cog"></i>';
      }
    });
    this.optionsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isPanelOpen = this.optionsPanel.classList.toggle('open');
      this.optionsBtn.innerHTML = isPanelOpen
        ? '<i class="fas fa-times"></i>'
        : '<i class="fas fa-cog"></i>';
    });
    this.zoomSlider.addEventListener('input', () => {
      this.zoomValue.textContent = `${this.zoomSlider.value}%`;
      localStorage.setItem('mdw_zoom', this.zoomSlider.value);
      this.setEditorStyles();
    });
    this.colorPicker.addEventListener('input', () => {
      this.colorValue.textContent = this.colorPicker.value;
      localStorage.setItem('mdw_text_color', this.colorPicker.value);
      this.setEditorStyles();
    });
    this.openDyslexicToggle.addEventListener('change', () => {
      localStorage.setItem('mdw_opendyslexic', this.openDyslexicToggle.checked ? 'on' : 'off');
      this.fontToggleLabel.textContent = this.openDyslexicToggle.checked ? 'Enabled' : 'Disabled';
      this.setEditorStyles();
    });
    this.draftTitle.addEventListener('input', () => this.scheduleAutoSave());
    this.newDraftBtn.addEventListener('click', () => this.createNewDraft());
    this.editor.addEventListener('input', () => this.scheduleAutoSave());
    this.editor.addEventListener('mouseup', () => this.handleSelectionChange());
    this.editor.addEventListener('keyup', () => this.handleSelectionChange());
    document.addEventListener('selectionchange', () => this.handleSelectionChange());
    document.addEventListener('scroll', () => this.hideToolbar());
    document.addEventListener('mousedown', (e) => {
      if (!this.formattingToolbar.contains(e.target)) this.hideToolbar();
    });
    this.formattingToolbar.addEventListener('mousedown', (e) => {
      e.preventDefault();
    });
    this.formattingToolbar.addEventListener('click', (e) => {
      if (e.target.closest('button')) {
        this.applyFormat(e.target.closest('button').dataset.format);
        this.hideToolbar();
      }
    });
    this.modalConfirmBtn.addEventListener('click', () => {
      this.modalPromiseResolve(true);
      this.confirmationModal.style.display = 'none';
    });
    this.modalCancelBtn.addEventListener('click', () => {
      this.modalPromiseResolve(false);
      this.confirmationModal.style.display = 'none';
    });
  }
  setEditorStyles() {
    // Font size
    const zoom = this.zoomSlider.value || 100;
    document.documentElement.style.setProperty('--editor-font-size', `${zoom / 100 * 1.1}rem`);
    // Text color
    const color = this.colorPicker.value || '#181818';
    document.documentElement.style.setProperty('--text-color', color);
    // Font
    const useDyslexic = this.openDyslexicToggle.checked;
    document.documentElement.style.setProperty('--editor-font',
      useDyslexic ? "'OpenDyslexic', Arial, sans-serif" : "Arial, sans-serif"
    );
  }
  applySettingsFromLocalStorage() {
    if (localStorage.getItem('mdw_zoom')) {
      this.zoomSlider.value = localStorage.getItem('mdw_zoom');
      this.zoomValue.textContent = `${this.zoomSlider.value}%`;
    }
    if (localStorage.getItem('mdw_text_color')) {
      this.colorPicker.value = localStorage.getItem('mdw_text_color');
      this.colorValue.textContent = this.colorPicker.value;
    }
    if (localStorage.getItem('mdw_opendyslexic')) {
      this.openDyslexicToggle.checked = localStorage.getItem('mdw_opendyslexic') === 'on';
      this.fontToggleLabel.textContent = this.openDyslexicToggle.checked ? 'Enabled' : 'Disabled';
    }
    this.setEditorStyles();
  }
  handleSelectionChange() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return this.hideToolbar();
    const range = selection.getRangeAt(0);
    if (!selection.isCollapsed && this.editor.contains(range.startContainer) && this.editor.contains(range.endContainer)) {
      const rect = range.getBoundingClientRect();
      let toolbarLeft = rect.left + window.scrollX - this.formattingToolbar.offsetWidth / 2 + rect.width / 2;
      let toolbarTop = rect.top + window.scrollY - this.formattingToolbar.offsetHeight - 10;
      if (toolbarLeft < window.scrollX + 10) toolbarLeft = window.scrollX + 10;
      if (toolbarLeft + this.formattingToolbar.offsetWidth > window.innerWidth - 10)
        toolbarLeft = window.innerWidth - this.formattingToolbar.offsetWidth - 10;
      this.formattingToolbar.style.display = 'flex';
      this.formattingToolbar.style.left = `${toolbarLeft}px`;
      this.formattingToolbar.style.top = `${toolbarTop}px`;
    } else {
      this.hideToolbar();
    }
  }
  hideToolbar() {
    this.formattingToolbar.style.display = 'none';
  }
  applyFormat(command) {
    this.editor.focus();
    switch (command) {
      case 'bold':
        document.execCommand('bold', false, null);
        break;
      case 'italic':
        document.execCommand('italic', false, null);
        break;
      case 'h1':
        document.execCommand('formatBlock', false, 'H1');
        break;
      case 'h2':
        document.execCommand('formatBlock', false, 'H2');
        break;
      case 'h3':
        document.execCommand('formatBlock', false, 'H3');
        break;
      case 'blockquote':
        document.execCommand('formatBlock', false, 'BLOCKQUOTE');
        break;
      case 'code':
        this.toggleCode();
        break;
      case 'link':
        const url = prompt('Enter the URL:', 'https://');
        if (url) document.execCommand('createLink', false, url);
        break;
      default:
        console.warn('Unknown format command:', command);
        break;
    }
    this.scheduleAutoSave();
  }
  toggleCode() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    const range = selection.getRangeAt(0);
    const parentCode = this.findParentTag(range.commonAncestorContainer, 'CODE');
    if (parentCode) {
      // Toggle off code
      const fragment = document.createDocumentFragment();
      while (parentCode.firstChild) fragment.appendChild(parentCode.firstChild);
      parentCode.parentNode.replaceChild(fragment, parentCode);
    } else {
      // Toggle on code
      const codeNode = document.createElement('code');
      codeNode.appendChild(range.extractContents());
      range.insertNode(codeNode);
      selection.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNodeContents(codeNode);
      selection.addRange(newRange);
    }
  }
  findParentTag(node, tagName) {
    while (node && node !== this.editor) {
      if (node.nodeType === 1 && node.tagName === tagName) return node;
      node = node.parentNode;
    }
    return null;
  }
  placeCursorAtEnd() {
    const selection = window.getSelection();
    const range = document.createRange();
    if (this.editor.lastChild) {
      range.setStartAfter(this.editor.lastChild);
    } else {
      range.setStart(this.editor, 0);
    }
    range.collapse(true);
    selection.removeAllRanges();
    selection.addRange(range);
  }
  scheduleAutoSave() {
    clearTimeout(this.autoSaveTimer);
    this.autoSaveTimer = setTimeout(() => {
      this.saveDraft();
      this.saveDraftsToLocalStorage();
    }, 1000);
  }
  createNewDraft() {
    this.saveDraft();
    const draft = {
      id: Date.now(),
      title: '',
      content: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    this.drafts.unshift(draft);
    this.loadDraft(draft.id);
    this.renderDrafts();
    this.saveDraftsToLocalStorage();
    this.editor.innerHTML = '';
    this.placeCursorAtEnd();
  }
  loadDraft(id) {
    const draft = this.drafts.find(d => d.id === id);
    if (draft) {
      this.currentDraftId = id;
      this.draftTitle.value = draft.title;
      this.editor.innerHTML = draft.content;
      this.renderDrafts();
      this.placeCursorAtEnd();
    }
  }
  saveDraft() {
    if (!this.currentDraftId) return;
    const draft = this.drafts.find(d => d.id === this.currentDraftId);
    if (draft) {
      const content = this.editor.innerHTML || '';
      draft.content = content;
      draft.updatedAt = new Date().toISOString();
      draft.title = this.draftTitle.value.trim() || this.generateTitleFromContent(this.editor.textContent || '');
    }
  }
  generateTitleFromContent(content) {
    if (!content.trim()) return 'Untitled Draft';
    const firstLine = content.split('\n')[0] || '';
    return firstLine.substring(0, 20) + (firstLine.length > 20 ? '...' : '') || 'Untitled Draft';
  }
  showConfirmationModal(message) {
    this.modalMessage.textContent = message;
    this.confirmationModal.style.display = 'flex';
    return new Promise((resolve) => {
      this.modalPromiseResolve = resolve;
    });
  }
  async deleteDraft(id) {
    const confirmed = await this.showConfirmationModal('Are you sure you want to delete this draft?');
    if (confirmed) {
      this.drafts = this.drafts.filter(d => d.id !== id);
      if (this.currentDraftId === id) {
        if (this.drafts.length > 0) {
          this.loadDraft(this.drafts[0].id);
        } else {
          this.currentDraftId = null;
          this.draftTitle.value = '';
          this.editor.innerHTML = '';
        }
      }
      this.renderDrafts();
      this.saveDraftsToLocalStorage();
    }
  }
  renderDrafts() {
    this.draftsList.innerHTML = '';
    if (this.drafts.length === 0) {
      this.draftsList.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No drafts</div>';
      return;
    }
    this.drafts.forEach((draft, i) => {
      const draftEl = document.createElement('div');
      draftEl.className = `draft-item${draft.id === this.currentDraftId ? ' active' : ''}`;
      draftEl.setAttribute('draggable', true);
      draftEl.dataset.index = i;
      draftEl.dataset.id = draft.id;

      // --- Draft Info ---
      const infoDiv = document.createElement('div');
      infoDiv.className = 'draft-info';
      infoDiv.innerHTML = `
        <span class="draft-title">${draft.title || 'Untitled Draft'}</span>
        <br>
        <span class="draft-date">${new Date(draft.updatedAt).toLocaleString()}</span>
      `;
      // Clicking info opens draft
      infoDiv.addEventListener('click', (e) => {
        this.saveDraft();
        this.loadDraft(draft.id);
      });

      // --- Delete Button ---
      const delBtn = document.createElement('button');
      delBtn.className = 'draft-delete';
      delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.deleteDraft(draft.id);
      });

      draftEl.appendChild(infoDiv);
      draftEl.appendChild(delBtn);

      // --- Drag and Drop Handlers ---
      draftEl.addEventListener('dragstart', (e) => {
        draftEl.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', i);
      });
      draftEl.addEventListener('dragend', (e) => {
        draftEl.classList.remove('dragging');
        this.renderDrafts();
      });
      draftEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        const dragging = this.draftsList.querySelector('.dragging');
        if (dragging !== draftEl) draftEl.classList.add('drag-over');
      });
      draftEl.addEventListener('dragleave', (e) => {
        draftEl.classList.remove('drag-over');
      });
      draftEl.addEventListener('drop', (e) => {
        e.preventDefault();
        draftEl.classList.remove('drag-over');
        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
        const toIndex = i;
        this.moveDraft(fromIndex, toIndex);
      });

      this.draftsList.appendChild(draftEl);
    });
  }
  moveDraft(from, to) {
    if (from === to) return;
    const draft = this.drafts.splice(from, 1)[0];
    this.drafts.splice(to, 0, draft);
    this.saveDraftsToLocalStorage();
    this.renderDrafts();
  }
  saveDraftsToLocalStorage() {
    try {
      const serializableDrafts = this.drafts.map(draft => ({
        ...draft,
        createdAt: draft.createdAt instanceof Date ? draft.createdAt.toISOString() : draft.createdAt,
        updatedAt: draft.updatedAt instanceof Date ? draft.updatedAt.toISOString() : draft.updatedAt,
      }));
      localStorage.setItem(this.localStorageKey, JSON.stringify(serializableDrafts));
    } catch (err) {
      // handle silently
    }
  }
  loadDraftsFromLocalStorage() {
    try {
      const storedDrafts = localStorage.getItem(this.localStorageKey);
      if (storedDrafts) {
        this.drafts = JSON.parse(storedDrafts).map(draft => ({
          ...draft,
          createdAt: new Date(draft.createdAt),
          updatedAt: new Date(draft.updatedAt)
        }));
        if (this.drafts.length > 0) {
          this.currentDraftId = this.drafts[0].id;
          this.draftTitle.value = this.drafts[0].title;
          this.editor.innerHTML = this.drafts[0].content;
        }
      }
    } catch (err) {
      // handle silently
    }
  }
}
document.addEventListener('DOMContentLoaded', () => {
  new LiveMarkdownEditor();
});
</script>
</body>
</html>
