<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Markdown Editor</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css rel=stylesheet>
<style>@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Regular.otf') format('opentype');font-weight:400;font-style:normal}@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold.otf') format('opentype');font-weight:700;font-style:normal}@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Italic.otf') format('opentype');font-weight:400;font-style:italic}@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold-Italic.otf') format('opentype');font-weight:700;font-style:italic}:root{--bg-primary:#0d1117;--bg-secondary:#161b22;--bg-tertiary:#21262d;--text-primary:#f0f6fc;--text-secondary:#7d8590;--accent:#58a6ff;--accent-hover:#388bfd;--border:#30363d;--success:#238636;--danger:#da3633;--font-family:Arial,sans-serif}body.light-mode{--bg-primary:#ffffff;--bg-secondary:#f6f8fa;--bg-tertiary:#e1e4e8;--text-primary:#24292e;--text-secondary:#586069;--accent:#0366d6;--accent-hover:#005cc5;--border:#d1d5da;--success:#28a745;--danger:#cb2431}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden;transition:background .3s ease,color .3s ease}body.use-opendyslexic{font-family:OpenDyslexic,Arial,sans-serif}.app-container{display:flex;height:100vh;position:relative}.options-btn{position:fixed;top:20px;right:20px;z-index:1000;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-primary);padding:12px;border-radius:50%;cursor:pointer;font-size:16px;transition:all .2s ease;box-shadow:0 4px 12px rgba(0,0,0,.3);width:44px;height:44px;display:flex;align-items:center;justify-content:center}.options-btn:hover{background:var(--accent);border-color:var(--accent)}.options-panel{position:fixed;top:0;right:-400px;width:400px;height:100vh;background:var(--bg-secondary);border-left:1px solid var(--border);transition:right .3s ease;z-index:999;display:flex;flex-direction:column;box-shadow:-4px 0 12px rgba(0,0,0,.3)}.options-panel.open{right:0}.options-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.options-content{flex:1;padding:20px;overflow-y:auto}.option-group{margin-bottom:24px}.option-label{display:block;margin-bottom:8px;font-weight:700;color:var(--text-primary)}.option-control{width:100%;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:12px;border-radius:6px;font-family:inherit;font-size:14px;transition:background .3s ease,border-color .3s ease,color .3s ease}.option-control:focus{outline:0;border-color:var(--accent)}.zoom-control{display:flex;align-items:center;gap:12px}.zoom-slider{flex:1;accent-color:var(--accent)}.zoom-value{min-width:50px;text-align:center;font-weight:700}.drafts-section{flex:1}.drafts-list{max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:var(--bg-tertiary)}.draft-item{padding:12px;border-bottom:1px solid var(--border);cursor:grab;transition:background .2s ease;position:relative}.draft-item:last-child{border-bottom:0}.draft-item:hover{background:var(--bg-primary)}.draft-item.active{background:var(--accent);color:#fff}.draft-item.dragging{opacity:.5;border:2px dashed var(--accent)}.draft-title{font-weight:700;margin-bottom:4px}.draft-preview{font-size:12px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.draft-item.active .draft-preview{color:rgba(255,255,255,.8)}.draft-actions{margin-top:8px;display:flex;gap:8px;justify-content:flex-end}.draft-btn{background:var(--bg-primary);border:1px solid var(--border);color:var(--text-secondary);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px}.draft-btn:hover{color:var(--text-primary);border-color:var(--accent)}.btn{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:12px 16px;border-radius:6px;cursor:pointer;font-family:inherit;font-size:14px;transition:all .2s ease}.btn:hover{background:var(--accent);border-color:var(--accent)}.btn.primary{background:var(--success);border-color:var(--success)}.btn.primary:hover{background:#2ea043}.editor-container{flex:1;display:flex;flex-direction:column;position:relative}.editor-content{flex:1;background:var(--bg-primary);color:var(--text-primary);border:0;padding:40px;font-family:inherit;font-size:16px;line-height:1.6;letter-spacing:0;outline:0;overflow-y:auto;min-height:100%;word-wrap:break-word;white-space:pre-wrap}.editor-content:empty::before{content:"Start typing here... Highlight text to format!";color:var(--text-secondary);font-style:italic}.editor-content h1{font-size:2em;font-weight:700;margin:.5em 0;color:var(--accent);border-bottom:2px solid var(--border);padding-bottom:.3em;display:block}.editor-content h2{font-size:1.7em;font-weight:700;margin:.5em 0;color:var(--accent);border-bottom:1px solid var(--border);padding-bottom:.2em;display:block}.editor-content h3{font-size:1.4em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content h4{font-size:1.2em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content h5{font-size:1.1em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content h6{font-size:1em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content strong{font-weight:700;color:var(--text-primary)}.editor-content em{font-style:italic;color:#ffa657}.editor-content code{background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;font-family:'Courier New',monospace;font-size:.9em;color:#f97583}.editor-content pre{background:var(--bg-tertiary);padding:16px;border-radius:8px;margin:1em 0;overflow-x:auto;font-family:'Courier New',monospace;font-size:.9em;color:#f97583}.editor-content blockquote{border-left:4px solid var(--accent);padding-left:16px;margin:1em 0;color:var(--text-secondary);font-style:italic;background:rgba(88,166,255,.05);padding:16px;border-radius:0 6px 6px 0;display:block}.editor-content ol,.editor-content ul{padding-left:24px;margin:1em 0}.editor-content li{margin:.5em 0}.markdown-syntax{color:var(--text-secondary);font-size:.8em}.modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6);justify-content:center;align-items:center}.modal-content{background-color:var(--bg-secondary);margin:auto;padding:20px;border:1px solid var(--border);border-radius:8px;width:80%;max-width:400px;box-shadow:0 5px 15px rgba(0,0,0,.5);text-align:center}.modal-content p{margin-bottom:20px;color:var(--text-primary)}.modal-buttons{display:flex;justify-content:space-around;gap:10px}.modal-buttons button{flex:1;padding:10px 15px;border-radius:5px;cursor:pointer;font-family:inherit;font-size:14px;transition:background .2s ease}.modal-buttons .confirm-btn{background-color:var(--danger);color:#fff;border:1px solid var(--danger)}.modal-buttons .confirm-btn:hover{background-color:#b32d2c}.modal-buttons .cancel-btn{background-color:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}.modal-buttons .cancel-btn:hover{background-color:var(--bg-primary)}.formatting-toolbar{display:none;position:absolute;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1000;gap:5px;flex-wrap:wrap;align-items:center}.formatting-toolbar button,.formatting-toolbar input[type=color]{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:8px 12px;border-radius:5px;cursor:pointer;font-size:14px;transition:background .2s,border-color .2s;-webkit-appearance:none;-moz-appearance:none;appearance:none;width:40px;height:40px;padding:0}.formatting-toolbar button:hover,.formatting-toolbar input[type=color]:hover{background:var(--accent);border-color:var(--accent)}.formatting-toolbar input[type=color]::-webkit-color-swatch-wrapper{padding:0}.formatting-toolbar input[type=color]::-webkit-color-swatch{border:none;border-radius:4px}.formatting-toolbar input[type=color]::-moz-color-swatch-wrapper{padding:0}.formatting-toolbar input[type=color]::-moz-color-swatch{border:none;border-radius:4px}.search-replace-bar{position:absolute;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border);padding:10px 20px;display:flex;gap:10px;align-items:center;z-index:990;transform:translateY(100%);transition:transform .3s ease-out}.search-replace-bar.open{transform:translateY(0)}.search-replace-bar input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:8px 12px;border-radius:6px;font-family:inherit;font-size:14px}.search-replace-bar button{background:var(--accent);border:1px solid var(--accent);color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;transition:background .2s ease}.search-replace-bar button:hover{background:var(--accent-hover);border-color:var(--accent-hover)}.search-replace-bar .close-btn{background:0 0;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer;padding:0 5px}.search-replace-bar .close-btn:hover{color:var(--text-primary)}.highlight{background-color:rgba(255,255,0,.5);border-radius:2px}#fileInput{display:none}.embed-container{border:1px solid var(--border);border-radius:8px;overflow:hidden;margin:1em 0;position:relative;padding-bottom:56.25%;height:0;background-color:var(--bg-tertiary)}.embed-container iframe{position:absolute;top:0;left:0;width:100%;height:100%;border:none}.embed-fullscreen-btn{position:absolute;bottom:5px;right:5px;background-color:rgba(0,0,0,.6);color:#fff;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:12px;z-index:10;opacity:.8}.embed-fullscreen-btn:hover{opacity:1}.fullscreen-embed-modal{display:none;position:fixed;z-index:1002;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.9);justify-content:center;align-items:center}.fullscreen-embed-modal.open{display:flex}.fullscreen-embed-modal iframe{width:90%;height:90%;border:none}.fullscreen-embed-modal .close-btn{position:absolute;top:20px;right:20px;background:0 0;border:none;color:#fff;font-size:30px;cursor:pointer}@media(max-width:768px){.options-panel{width:100vw;right:-100vw}.editor-content{padding:20px;font-size:14px}.formatting-toolbar{flex-direction:row;flex-wrap:wrap;max-width:90vw}.search-replace-bar{flex-wrap:wrap;justify-content:center}.search-replace-bar button,.search-replace-bar input{width:100%}}</style>
</head>
<body>
<div class=app-container>
<button class=options-btn id=optionsBtn>
<i class="fas fa-cog"></i>
</button>
<div class=options-panel id=optionsPanel>
<div class=options-header>
<h3>Settings</h3>
</div>
<div class=options-content>
<div class=option-group>
<label class=option-label>Draft Title (Optional)</label>
<input class=option-control id=draftTitle placeholder="Leave empty to auto-generate from content">
</div>
<div class=option-group>
<label class=option-label>Text Size</label>
<div class=zoom-control>
<span>Small</span>
<input type=range class=zoom-slider id=zoomSlider min=50 max=200 value=100>
<span class=zoom-value id=zoomValue>100%</span>
</div>
</div>
<div class=option-group>
<label class=option-label>Font Preference</label>
<input type=checkbox id=toggleOpenDyslexic> Use OpenDyslexic Font
</div>
<div class=option-group>
<label class=option-label>Theme</label>
<input type=checkbox id=toggleLightMode> Light Mode
</div>
<div class=option-group>
<button class="btn primary" id=newDraft>New Draft</button>
</div>
<div class="option-group drafts-section">
<label class=option-label>Drafts</label>
<div class=drafts-list id=draftsList>
</div>
</div>
<div class=option-group>
<label class=option-label>Import File</label>
<input type=file id=fileInput accept=.md,.html,.txt>
<button class=btn id=importFileBtn>Import File</button>
</div>
<div class=option-group>
<label class=option-label>Download Options</label>
<button class=btn id=downloadMarkdown>Download .md</button>
<button class=btn id=downloadHTML>Download .html</button>
<button class=btn id=downloadTXT>Download .txt</button>
</div>
</div>
</div>
<div class=editor-container>
<div class=editor-content id=editor contenteditable=true></div>
<div class=search-replace-bar id=searchReplaceBar>
<input id=searchTerm placeholder=Find...>
<input id=replaceTerm placeholder="Replace with...">
<button id=findNextBtn title="Find Next"><i class="fas fa-arrow-down"></i></button>
<button id=findPrevBtn title="Find Previous"><i class="fas fa-arrow-up"></i></button>
<button id=replaceAllBtn title="Replace All"><i class="fas fa-redo"></i> All</button>
<button class=close-btn id=closeSearchBtn><i class="fas fa-times"></i></button>
</div>
</div>
</div>
<div id=formattingToolbar class=formatting-toolbar>
<button data-format=bold><i class="fas fa-bold"></i></button>
<button data-format=italic><i class="fas fa-italic"></i></button>
<button data-format=h1>H1</button>
<button data-format=h2>H2</button>
<button data-format=h3>H3</button>
<button data-format=blockquote><i class="fas fa-quote-right"></i></button>
<button data-format=code><i class="fas fa-code"></i></button>
<button data-format=link><i class="fas fa-link"></i></button>
<input type=color id=textColorPicker value=#f0f6fc>
</div>
<div id=confirmationModal class=modal>
<div class=modal-content>
<p id=modalMessage>Are you sure?</p>
<div class=modal-buttons>
<button class=confirm-btn id=modalConfirmBtn>Confirm</button>
<button class=cancel-btn id=modalCancelBtn>Cancel</button>
</div>
</div>
</div>
<div id=fullscreenEmbedModal class=fullscreen-embed-modal>
<button class=close-btn id=closeFullscreenEmbedBtn><i class="fas fa-times"></i></button>
<iframe id=fullscreenEmbedIframe src="" frameborder=0 allowfullscreen></iframe>
</div>
<script>class LiveMarkdownEditor{constructor(){this.drafts=[],this.currentDraftId=null,this.autoSaveTimer=null,this.localStorageKey="markdownEditorDrafts",this.searchResults=[],this.currentSearchIndex=-1,this.initElements(),this.bindEvents(),this.loadSettingsFromLocalStorage(),this.applySettings(),this.loadDraftsFromLocalStorage(),0===this.drafts.length?this.createNewDraft():this.loadDraft(this.drafts[0].id)}initElements(){this.editor=document.getElementById("editor"),this.optionsPanel=document.getElementById("optionsPanel"),this.draftsList=document.getElementById("draftsList"),this.draftTitle=document.getElementById("draftTitle"),this.zoomSlider=document.getElementById("zoomSlider"),this.zoomValue=document.getElementById("zoomValue"),this.optionsBtn=document.getElementById("optionsBtn"),this.formattingToolbar=document.getElementById("formattingToolbar"),this.formatButtons=this.formattingToolbar.querySelectorAll("button[data-format]"),this.textColorPicker=document.getElementById("textColorPicker"),this.confirmationModal=document.getElementById("confirmationModal"),this.modalMessage=document.getElementById("modalMessage"),this.modalConfirmBtn=document.getElementById("modalConfirmBtn"),this.modalCancelBtn=document.getElementById("modalCancelBtn"),this.toggleOpenDyslexic=document.getElementById("toggleOpenDyslexic"),this.toggleLightMode=document.getElementById("toggleLightMode"),this.downloadMarkdownBtn=document.getElementById("downloadMarkdown"),this.downloadHTMLBtn=document.getElementById("downloadHTML"),this.downloadTXTBtn=document.getElementById("downloadTXT"),this.searchReplaceBar=document.getElementById("searchReplaceBar"),this.searchTermInput=document.getElementById("searchTerm"),this.replaceTermInput=document.getElementById("replaceTerm"),this.findNextBtn=document.getElementById("findNextBtn"),this.findPrevBtn=document.getElementById("findPrevBtn"),this.replaceAllBtn=document.getElementById("replaceAllBtn"),this.closeSearchBtn=document.getElementById("closeSearchBtn"),this.fileInput=document.getElementById("fileInput"),this.importFileBtn=document.getElementById("importFileBtn"),this.fullscreenEmbedModal=document.getElementById("fullscreenEmbedModal"),this.fullscreenEmbedIframe=document.getElementById("fullscreenEmbedIframe"),this.closeFullscreenEmbedBtn=document.getElementById("closeFullscreenEmbedBtn")}bindEvents(){this.optionsBtn.addEventListener("click",(e=>{e.stopPropagation();const t=this.optionsPanel.classList.toggle("open");this.optionsBtn.innerHTML=t?'<i class="fas fa-times"></i>':'<i class="fas fa-cog"></i>'})),this.zoomSlider.addEventListener("input",(e=>{const t=e.target.value;this.editor.style.fontSize=t/100*16+"px",this.zoomValue.textContent=`${t}%`})),document.getElementById("newDraft").addEventListener("click",(()=>{this.createNewDraft()})),this.editor.addEventListener("input",(()=>{this.scheduleAutoSave(),this.clearSearchResults()})),this.editor.addEventListener("mouseup",this.handleSelectionChange.bind(this)),this.editor.addEventListener("keyup",this.handleSelectionChange.bind(this)),document.addEventListener("mousedown",(e=>{this.formattingToolbar.contains(e.target)||this.editor.contains(e.target)||this.searchReplaceBar.contains(e.target)||this.hideToolbar()})),this.draftTitle.addEventListener("input",(()=>{this.scheduleAutoSave()})),document.addEventListener("click",(e=>{this.optionsPanel.contains(e.target)||this.optionsBtn.contains(e.target)||(this.optionsPanel.classList.remove("open"),this.optionsBtn.innerHTML='<i class="fas fa-cog"></i>')})),this.formatButtons.forEach((e=>{e.addEventListener("click",(e=>{e.preventDefault();const t=e.currentTarget.dataset.format;this.applyFormat(t),this.hideToolbar()}))})),this.editor.addEventListener("keydown",(e=>{if("Tab"===e.key)e.preventDefault(),document.execCommand("insertText",!1,"    ");else if(e.ctrlKey||e.metaKey)switch(e.key){case"b":case"i":case"u":case"`":e.preventDefault();break;case"f":e.preventDefault(),this.toggleSearchReplaceBar(!0)}})),this.textColorPicker.addEventListener("input",(e=>{const t=e.target.value;this.applyColor(t),this.scheduleAutoSave(),this.hideToolbar()})),this.toggleOpenDyslexic.addEventListener("change",(e=>{this.settings.useOpenDyslexic=e.target.checked,this.applySettings(),this.saveSettingsToLocalStorage()})),this.toggleLightMode.addEventListener("change",(e=>{this.settings.lightMode=e.target.checked,this.applySettings(),this.saveSettingsToLocalStorage()})),this.downloadMarkdownBtn.addEventListener("click",(()=>this.downloadContent("md"))),this.downloadHTMLBtn.addEventListener("click",(()=>this.downloadContent("html"))),this.downloadTXTBtn.addEventListener("click",(()=>this.downloadContent("txt"))),this.searchTermInput.addEventListener("input",this.findText.bind(this)),this.findNextBtn.addEventListener("click",(()=>this.navigateToSearchResult(1))),this.findPrevBtn.addEventListener("click",(()=>this.navigateToSearchResult(-1))),this.replaceAllBtn.addEventListener("click",this.replaceAll.bind(this)),this.closeSearchBtn.addEventListener("click",this.toggleSearchReplaceBar.bind(this,!1)),this.editor.addEventListener("keydown",(e=>{"Escape"===e.key&&this.searchReplaceBar.classList.contains("open")&&this.toggleSearchReplaceBar(!1)})),this.importFileBtn.addEventListener("click",(()=>this.fileInput.click())),this.fileInput.addEventListener("change",this.importFile.bind(this)),this.closeFullscreenEmbedBtn.addEventListener("click",(()=>{this.fullscreenEmbedModal.classList.remove("open"),this.fullscreenEmbedIframe.src=""}))}handleSelectionChange(){const e=window.getSelection();if(!e.isCollapsed&&this.editor.contains(e.focusNode)&&this.editor.contains(e.anchorNode)){const t=e.getRangeAt(0).getBoundingClientRect();let n=t.top+window.scrollY-this.formattingToolbar.offsetHeight-10,o=t.left+window.scrollX+t.width/2-this.formattingToolbar.offsetWidth/2;n<window.scrollY+10&&(n=t.bottom+window.scrollY+10),o<window.scrollX+10&&(o=window.scrollX+10),o+this.formattingToolbar.offsetWidth>window.innerWidth-10&&(o=window.innerWidth-this.formattingToolbar.offsetWidth-10),this.formattingToolbar.style.display="flex",this.formattingToolbar.style.left=`${o}px`,this.formattingToolbar.style.top=`${n}px`}else this.hideToolbar()}hideToolbar(){this.formattingToolbar.style.display="none"}applyFormat(e){if(this.editor.focus(),this.clearSearchResults(),"link"===e){const e=prompt("Enter the URL:","https://");return e&&document.execCommand("createLink",!1,e),void this.scheduleAutoSave()}if("code"!==e)document.execCommand(e,!1,null),this.scheduleAutoSave();else{const e=window.getSelection();if(!e.rangeCount)return;const t=e.getRangeAt(0),n=t.commonAncestorContainer.closest("pre");if(n){document.execCommand("formatBlock",!1,"p");const e=window.getSelection();if(e.rangeCount){const t=e.getRangeAt(0).commonAncestorContainer.closest("code");if(t&&t.parentNode===n){const e=document.createDocumentFragment();for(;t.firstChild;)e.appendChild(t.firstChild);t.parentNode.replaceChild(e,t)}}}else{const n=t.extractContents(),o=document.createElement("pre"),s=document.createElement("code");s.appendChild(n),o.appendChild(s),t.insertNode(o),e.removeAllRanges();const r=document.createRange();r.selectNodeContents(s),e.addRange(r)}this.scheduleAutoSave()}}applyColor(e){this.editor.focus();const t=window.getSelection();if(!t.rangeCount)return;const n=t.getRangeAt(0);if(n.collapsed)return document.execCommand("foreColor",!1,e),void this.scheduleAutoSave();const o=n.extractContents();if(""===o.textContent.trim())return document.execCommand("foreColor",!1,e),void this.scheduleAutoSave();const s=document.createElement("span");s.style.color=e,s.appendChild(o),n.insertNode(s),t.removeAllRanges(),t.addRange(n),this.scheduleAutoSave()}placeCursorAtEnd(){const e=window.getSelection(),t=document.createRange();this.editor.lastChild?this.editor.lastChild.nodeType===Node.TEXT_NODE?t.setStart(this.editor.lastChild,this.editor.lastChild.textContent.length):t.setStartAfter(this.editor.lastChild):t.setStart(this.editor,0),t.collapse(!0),e.removeAllRanges(),e.addRange(t)}scheduleAutoSave(){clearTimeout(this.autoSaveTimer),this.autoSaveTimer=setTimeout((()=>{this.saveDraft(),this.saveDraftsToLocalStorage()}),1e3)}createNewDraft(){this.saveDraft();const e={id:Date.now(),title:"",content:"",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};this.drafts.unshift(e),this.loadDraft(e.id),this.renderDrafts(),this.saveDraftsToLocalStorage()}loadDraft(e){const t=this.drafts.find((t=>t.id===e));t&&(this.currentDraftId=e,this.draftTitle.value=t.title,this.editor.innerHTML=this.convertEmbedSyntaxToHtml(this.convertCustomColorSyntaxToHtml(t.content)),this.renderDrafts(),this.placeCursorAtEnd(),this.clearSearchResults())}saveDraft(){if(!this.currentDraftId)return;const e=this.drafts.find((e=>e.id===this.currentDraftId));if(e){const t=this.editor.innerHTML,n=this.convertHtmlToCustomColorSyntax(this.convertHtmlToEmbedSyntax(t)),o=this.editor.textContent||"";e.title=this.draftTitle.value||this.generateTitleFromContent(o),e.content=n,e.updatedAt=(new Date).toISOString(),this.renderDrafts()}}convertHtmlToCustomColorSyntax(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll('span[style*="color:"]').forEach((e=>{const t=e.style.color;let n="";const o=t.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(o){const e=e=>parseInt(e).toString(16).padStart(2,"0");n=`#${e(o[1])}${e(o[2])}${e(o[3])}`}else{if(!t.startsWith("#"))return void console.warn(`Could not convert color '${t}' to hex for custom syntax.`);n=t}const s=`<${n}>${e.innerHTML}</>`,r=document.createTextNode(s);e.parentNode.replaceChild(r,e)})),t.innerHTML}convertCustomColorSyntaxToHtml(e){return e.replace(/<#([0-9a-fA-F]{3,6})>(.*?)<\/>/gs,((e,t,n)=>`<span style="color: #${t}">${n}</span>`))}convertEmbedSyntaxToHtml(e){const t=(new DOMParser).parseFromString(`<root>${e}</root>`,"text/xml");return t.querySelectorAll("embed[href]").forEach((e=>{const t=e.getAttribute("href");if(t){const n=`\n                    <div class="embed-container" contenteditable="false">\n                        <iframe src="${t}" frameborder="0" allowfullscreen></iframe>\n                        <button class="embed-fullscreen-btn" onclick="document.dispatchEvent(new CustomEvent('open-fullscreen-embed', { detail: { href: '${t}' } }));">\n                            Fullscreen\n                        </button>\n                    </div>\n                `,o=document.createElement("div");o.innerHTML=n.trim(),e.replaceWith(...o.childNodes)}})),t.documentElement.innerHTML}convertHtmlToEmbedSyntax(e){const t=document.createElement("div");return t.innerHTML=e,t.querySelectorAll(".embed-container").forEach((e=>{const t=e.querySelector("iframe");if(t&&t.src){const n=`<embed href="${t.src}"/>`,o=document.createTextNode(n);e.parentNode.replaceChild(o,e)}})),t.innerHTML}generateTitleFromContent(e){if(!e.trim())return"Untitled Draft";const t=e.split("\n")[0]||"";return t.substring(0,20)+(t.length>20?"...":"")||"Untitled Draft"}showConfirmationModal(e){return new Promise((t=>{this.modalMessage.textContent=e,this.confirmationModal.style.display="flex";const n=()=>{this.confirmationModal.style.display="none",this.modalConfirmBtn.removeEventListener("click",n),this.modalCancelBtn.removeEventListener("click",o),t(!0)},o=()=>{this.confirmationModal.style.display="none",this.modalConfirmBtn.removeEventListener("click",n),this.modalCancelBtn.removeEventListener("click",o),t(!1)};this.modalConfirmBtn.addEventListener("click",n),this.modalCancelBtn.addEventListener("click",o)}))}async deleteDraft(e){await this.showConfirmationModal("Are you sure you want to delete this draft?")&&(this.drafts=this.drafts.filter((t=>t.id!==e)),this.currentDraftId===e&&(this.drafts.length>0?this.loadDraft(this.drafts[0].id):this.createNewDraft()),this.renderDrafts(),this.saveDraftsToLocalStorage())}renderDrafts(){this.draftsList.innerHTML="",0!==this.drafts.length?(this.drafts.forEach((e=>{const t=document.createElement("div");t.className="draft-item "+(e.id===this.currentDraftId?"active":""),t.draggable=!0,t.dataset.id=e.id;const n=document.createElement("div");n.innerHTML=this.convertCustomColorSyntaxToHtml(e.content);const o=n.textContent||n.innerText||"",s=e.title||this.generateTitleFromContent(o),r=o.substring(0,50)+(o.length>50?"...":"");t.innerHTML=`\n                <div class="draft-info">\n                    <div class="draft-title">${s}</div>\n                    <div class="draft-preview">${r||"Empty draft"}</div>\n                </div>\n                <div class="draft-actions">\n                    <button class="draft-btn" data-action="delete" data-id="${e.id}">Delete</button>\n                </div>\n            `,t.querySelector(".draft-info").addEventListener("click",(t=>{t.stopPropagation(),this.loadDraft(e.id)})),t.querySelector('[data-action="delete"]').addEventListener("click",(e=>{e.stopPropagation(),this.deleteDraft(parseInt(e.target.dataset.id))})),t.addEventListener("dragstart",(n=>{n.dataTransfer.setData("text/plain",e.id),t.classList.add("dragging")})),t.addEventListener("dragend",(()=>{t.classList.remove("dragging")})),this.draftsList.appendChild(t)})),this.draftsList.addEventListener("dragover",(e=>{e.preventDefault();const t=document.querySelector(".draft-item.dragging");if(t){const n=this.getDragAfterElement(this.draftsList,e.clientY);null==n?this.draftsList.appendChild(t):this.draftsList.insertBefore(t,n)}})),this.draftsList.addEventListener("drop",(e=>{e.preventDefault();const t=parseInt(e.dataTransfer.getData("text/plain"));if(this.drafts.find((e=>e.id===t))){const e=Array.from(this.draftsList.children).map((e=>parseInt(e.dataset.id))),t=[];for(const n of e){const e=this.drafts.find((e=>e.id===n));e&&t.push(e)}this.drafts=t,this.saveDraftsToLocalStorage()}}))):this.draftsList.innerHTML='<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No drafts</div>'}getDragAfterElement(e,t){return[...e.querySelectorAll(".draft-item:not(.dragging)")].reduce(((e,n)=>{const o=n.getBoundingClientRect(),s=t-o.top-o.height/2;return s<0&&s>e.offset?{offset:s,element:n}:e}),{offset:-1/0}).element}saveDraftsToLocalStorage(){try{const e=this.drafts.map((e=>({...e,createdAt:e.createdAt instanceof Date?e.createdAt.toISOString():e.createdAt,updatedAt:e.updatedAt instanceof Date?e.updatedAt.toISOString():e.updatedAt})));localStorage.setItem(this.localStorageKey,JSON.stringify(e)),console.log("Drafts saved to localStorage ✅")}catch(e){console.error("Failed to save drafts to localStorage:",e)}}loadDraftsFromLocalStorage(){try{const e=localStorage.getItem(this.localStorageKey);e&&(this.drafts=JSON.parse(e).map((e=>({...e,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)}))),this.drafts.forEach((e=>{e.content=this.convertEmbedSyntaxToHtml(this.convertCustomColorSyntaxToHtml(e.content))})),console.log("Drafts loaded from localStorage ✨"))}catch(e){console.error("Failed to load drafts from localStorage:",e)}}settings={useOpenDyslexic:!0,lightMode:!1};saveSettingsToLocalStorage(){try{localStorage.setItem("markdownEditorSettings",JSON.stringify(this.settings)),console.log("Settings saved to localStorage ⚙️")}catch(e){console.error("Couldn't save settings to localStorage:",e)}}loadSettingsFromLocalStorage(){try{const e=localStorage.getItem("markdownEditorSettings");e&&(this.settings={...this.settings,...JSON.parse(e)},console.log("Settings loaded from localStorage 🚀"))}catch(e){console.error("Failed to load settings from localStorage:",e)}}applySettings(){this.settings.useOpenDyslexic?(document.body.classList.add("use-opendyslexic"),this.editor.style.fontFamily="'OpenDyslexic', Arial, sans-serif"):(document.body.classList.remove("use-opendyslexic"),this.editor.style.fontFamily="Arial, sans-serif"),this.toggleOpenDyslexic.checked=this.settings.useOpenDyslexic,this.settings.lightMode?document.body.classList.add("light-mode"):document.body.classList.remove("light-mode"),this.toggleLightMode.checked=this.settings.lightMode}downloadContent(e){const t=this.drafts.find((e=>e.id===this.currentDraftId));if(!t)return void this.showConfirmationModal("No draft selected to download.");let n=(t.title||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase(),o="",s="";const r=this.editor.innerHTML;switch(e){case"md":o=this.convertHtmlToMarkdown(r),s="text/markdown",n+=".md";break;case"html":o=r,s="text/html",n+=".html";break;case"txt":const t=document.createElement("div");t.innerHTML=r,o=t.textContent||t.innerText||"",o=o.replace(/<#([0-9a-fA-F]{3,6})>(.*?)<\/>/gs,"$2"),s="text/plain",n+=".txt";break;default:return void console.warn("Unsupported download format:",e)}const i=new Blob([o],{type:s}),a=URL.createObjectURL(i),l=document.createElement("a");l.href=a,l.download=n,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(a)}convertHtmlToMarkdown(e){let t=document.createElement("div");t.innerHTML=e,t.querySelectorAll('span[style*="color:"]').forEach((e=>{const t=document.createTextNode(e.textContent);e.parentNode.replaceChild(t,e)})),t.querySelectorAll(".embed-container").forEach((e=>{e.parentNode.removeChild(e)}));let n=t.innerHTML;return n=n.replace(/<h1>(.*?)<\/h1>/g,"# $1\n"),n=n.replace(/<h2>(.*?)<\/h2>/g,"## $1\n"),n=n.replace(/<h3>(.*?)<\/h3>/g,"### $1\n"),n=n.replace(/<h4>(.*?)<\/h4>/g,"#### $1\n"),n=n.replace(/<h5>(.*?)<\/h5>/g,"##### $1\n"),n=n.replace(/<h6>(.*?)<\/h6>/g,"###### $1\n"),n=n.replace(/<strong>(.*?)<\/strong>/g,"**$1**"),n=n.replace(/<b>(.*?)<\/b>/g,"**$1**"),n=n.replace(/<em>(.*?)<\/em>/g,"*$1*"),n=n.replace(/<i>(.*?)<\/i>/g,"*$1*"),n=n.replace(/<blockquote>([\s\S]*?)<\/blockquote>/g,((e,t)=>t.split("\n").map((e=>`> ${e.trim()}`)).join("\n").trim()+"\n\n")),n=n.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g,"```\n$1\n```\n"),n=n.replace(/<code>(.*?)<\/code>/g,"`$1`"),n=n.replace(/<a href="(.*?)">(.*?)<\/a>/g,"[$2]($1)"),n=n.replace(/<ul>([\s\S]*?)<\/ul>/gs,((e,t)=>t.replace(/<li>([\s\S]*?)<\/li>/g,((e,t)=>{const n=t.trim().split("\n");return`- ${n[0]}\n`+n.slice(1).map((e=>`  ${e}`)).join("\n")+"\n"})))),n=n.replace(/<ol>([\s\S]*?)<\/ol>/gs,((e,t)=>{let n=1;return t.replace(/<li>([\s\S]*?)<\/li>/g,((e,t)=>{const o=t.trim().split("\n");return`${n++}. ${o[0]}\n`+o.slice(1).map((e=>`   ${e}`)).join("\n")+"\n"}))})),n=n.replace(/<br\s*\/?>/g,"\n"),n=n.replace(/\n{3,}/g,"\n\n").trim(),n}toggleSearchReplaceBar(e){"boolean"==typeof e?e?(this.searchReplaceBar.classList.add("open"),this.searchTermInput.focus(),this.findText()):(this.searchReplaceBar.classList.remove("open"),this.clearSearchResults()):(this.searchReplaceBar.classList.toggle("open"),this.searchReplaceBar.classList.contains("open")?(this.searchTermInput.focus(),this.findText()):this.clearSearchResults())}findText(){this.clearSearchResults();const e=this.searchTermInput.value.trim();if(""===e)return;const t=document.createElement("div");t.innerHTML=this.editor.innerHTML;let n=t.textContent;const o=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");let s;for(this.searchResults=[];null!==(s=o.exec(n));)this.searchResults.push({start:s.index,end:s.index+s[0].length});this.searchResults.length>0?(this.highlightSearchResults(),this.currentSearchIndex=0,this.scrollToSearchResult(this.currentSearchIndex),this.updateActiveHighlight(this.currentSearchIndex)):this.currentSearchIndex=-1}highlightSearchResults(){this.clearHighlights();const e=this.editor.innerHTML,t=document.createElement("div");t.innerHTML=e,this.searchResults.forEach(((e,n)=>{const o=document.createRange();let s=0,r=null,i=null,a=0,l=0;const d=document.createTreeWalker(t,NodeFilter.SHOW_TEXT);let c;for(;c=d.nextNode();){const t=c.nodeValue.length;if(null===r&&e.start>=s&&e.start<s+t&&(r=c,a=e.start-s),null===i&&e.end>s&&e.end<=s+t&&(i=c,l=e.end-s),r&&i)break;s+=t}if(r&&i)try{o.setStart(r,a),o.setEnd(i,l);const e=document.createElement("span");e.className="highlight",e.dataset.searchIndex=n,o.surroundContents(e)}catch(t){console.warn("Could not highlight range:",t,e,r,i)}})),this.editor.innerHTML=t.innerHTML,this.editor.normalize()}clearHighlights(){this.editor.querySelectorAll(".highlight").forEach((e=>{const t=e.parentNode;for(;e.firstChild;)t.insertBefore(e.firstChild,e);t.removeChild(e),t.normalize()}))}clearSearchResults(){this.clearHighlights(),this.searchResults=[],this.currentSearchIndex=-1}navigateToSearchResult(e){0!==this.searchResults.length&&(this.currentSearchIndex+=e,this.currentSearchIndex>=this.searchResults.length?this.currentSearchIndex=0:this.currentSearchIndex<0&&(this.currentSearchIndex=this.searchResults.length-1),this.scrollToSearchResult(this.currentSearchIndex),this.updateActiveHighlight(this.currentSearchIndex))}scrollToSearchResult(e){const t=this.editor.querySelector(`.highlight[data-search-index="${e}"]`);t&&t.scrollIntoView({behavior:"smooth",block:"center"})}updateActiveHighlight(e){this.editor.querySelectorAll(".highlight").forEach(((t,n)=>{t.style.backgroundColor=n===e?"rgba(255, 165, 0, 0.7)":"rgba(255, 255, 0, 0.5)"}))}replaceAll(){const e=this.searchTermInput.value,t=this.replaceTermInput.value;if(!e)return void this.showConfirmationModal("Please enter a term to find.");const n=new RegExp(e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");this.clearHighlights();const o=document.createElement("div");o.innerHTML=this.editor.innerHTML;const s=document.createTreeWalker(o,NodeFilter.SHOW_TEXT,null,!1);let r;const i=[];for(;r=s.nextNode();)r.nodeValue.includes(e)&&i.push(r);i.forEach((e=>{const o=e.nodeValue.replace(n,(e=>(t)));e.nodeValue=o})),this.editor.innerHTML=o.innerHTML,this.scheduleAutoSave(),this.findText(),this.showConfirmationModal(`All occurrences of "${e}" replaced with "${t}".`)}async importFile(e){const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=async n=>{const o=n.target.result,s=t.name,r=s.split(".").pop().toLowerCase();let i=o;if("md"===r||"txt"===r)i=this.markdownToHtml(o),i=this.convertCustomColorSyntaxToHtml(i),i=this.convertEmbedSyntaxToHtml(i);else{if("html"!==r)return void this.showConfirmationModal(`Unsupported file type: .${r}`);i=this.convertCustomColorSyntaxToHtml(o),i=this.convertEmbedSyntaxToHtml(i)}const a=s.replace(/\.[^/.]+$/,"");this.saveDraft();const l={id:Date.now(),title:a,content:this.convertHtmlToCustomColorSyntax(this.convertHtmlToEmbedSyntax(i)),createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};this.drafts.unshift(l),this.loadDraft(l.id),this.renderDrafts(),this.saveDraftsToLocalStorage(),this.showConfirmationModal(`File "${s}" imported successfully!`),e.target.value=""},n.onerror=()=>{this.showConfirmationModal("Error reading file.")},n.readAsText(t)}markdownToHtml(e){let t=e;return t=t.replace(/^###### (.*$)/gm,"<h6>$1</h6>"),t=t.replace(/^##### (.*$)/gm,"<h5>$1</h5>"),t=t.replace(/^#### (.*$)/gm,"<h4>$1</h4>"),t=t.replace(/^### (.*$)/gm,"<h3>$1</h3>"),t=t.replace(/^## (.*$)/gm,"<h2>$1</h2>"),t=t.replace(/^# (.*$)/gm,"<h1>$1</h1>"),t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.*?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.*?)\*/g,"<em>$1</em>"),t=t.replace(/_(.*?)_/g,"<em>$1</em>"),t=t.replace(/^> (.*$)/gm,"<blockquote>$1</blockquote>"),t=t.replace(/<\/blockquote>\n<blockquote>/g,"\n"),t=t.replace(/```([\s\S]*?)```/g,"<pre><code>$1</code></pre>"),t=t.replace(/`(.*?)`/g,"<code>$1</code>"),t=t.replace(/\[(.*?)\]\((.*?)\)/g,'<a href="$2">$1</a>'),t=t.replace(/^\s*[\-\*] (.*$)/gm,"<li>$1</li>"),t=t.replace(/(<li>[\s\S]*?<\/li>)/g,"<ul>$1</ul>"),t=t.replace(/<\/ul>\n<ul>/g,""),t=t.replace(/^\s*\d+\. (.*$)/gm,"<li>$1</li>"),t=t.replace(/(<li>[\s\S]*?<\/li>)/g,"<ol>$1</ol>"),t=t.replace(/<\/ol>\n<ol>/g,""),t=t.split("\n").map((e=>""===e.trim()?"<br>":(e.match(/<\/?(h\d|ul|ol|blockquote|pre|code|a|strong|em)>/),e))).join(""),t=t.replace(/(<br>)+/g,"<br>"),t}}document.addEventListener("open-fullscreen-embed",(e=>{const t=e.detail.href,n=document.getElementById("fullscreenEmbedModal");document.getElementById("fullscreenEmbedIframe").src=t,n.classList.add("open")})),document.addEventListener("DOMContentLoaded",(()=>{new LiveMarkdownEditor}))</script>
</body>
</html>
