<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markdown Editor</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
  /* OpenDyslexic Font Faces */
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Regular.otf') format('opentype');
    font-weight: normal;
    font-style: normal;
  }
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold.otf') format('opentype');
    font-weight: bold;
    font-style: normal;
  }
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Italic.otf') format('opentype');
    font-weight: normal;
    font-style: italic;
  }
  @font-face {
    font-family: 'OpenDyslexic';
    src: url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold-Italic.otf') format('opentype');
    font-weight: bold;
    font-style: italic;
  }

  :root {
    --editor-font: 'OpenDyslexic', Arial, sans-serif;
    --editor-font-size: 1.1rem;
    --editor-line-height: 1.6;
    --editor-letter-spacing: 0.04em;
    --text-color: #181818;
  }

  body {
    margin: 0;
    font-family: var(--editor-font);
    background: #f9f9fb;
    color: var(--text-color);
    transition: background 0.2s, color 0.2s;
  }

  .app-container {
    display: flex;
    height: 100vh;
  }

  /* --- Options Button --- */
  .options-btn {
    position: absolute;
    left: 1rem;
    top: 1rem;
    width: 42px;
    height: 42px;
    border: none;
    background: #fff;
    border-radius: 50%; /* Ensures circular shape */
    box-shadow: 0 2px 10px rgba(0,0,0,0.07);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
    transition: background 0.2s, box-shadow 0.2s;
    padding: 0;
  }
  .options-btn i {
    font-size: 1.6rem;
    margin: 0;
    padding: 0;
  }
  .options-btn:active {
    background: #eee;
  }

  /* --- Options Panel --- */
  .options-panel {
    position: absolute;
    left: 0;
    top: 0;
    width: 340px;
    height: 100%;
    background: #fff;
    border-right: 1px solid #eee;
    transform: translateX(-360px);
    transition: transform 0.2s cubic-bezier(.4,0,.2,1);
    z-index: 90;
    box-shadow: 2px 0 12px rgba(0,0,0,0.05);
    display: flex;
    flex-direction: column;
    overflow-y: auto;
  }
  .options-panel.open {
    transform: translateX(0);
  }
  .options-header {
    padding: 1.2rem 1.5rem 0.8rem 1.5rem;
    border-bottom: 1px solid #f0f0f0;
  }
  .options-header h3 { margin: 0; }

  .options-content { padding: 1rem 1.5rem; }
  .option-group { margin-bottom: 1.5rem; }
  .option-label { display: block; font-size: 1rem; margin-bottom: 0.5rem; font-weight: bold; }

  .option-control, .zoom-slider {
    width: 100%;
    padding: 0.3rem 0.5rem;
    font-size: 1rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    outline: none;
    margin-bottom: 0.2rem;
  }

  .btn.primary {
    background: #2679e8;
    color: #fff;
    border: none;
    padding: 0.6rem 1.4rem;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
  }
  .btn.primary:hover { background: #1656b7; }

  /* --- Drafts Section --- */
  .drafts-list {
    max-height: 18rem;
    overflow-y: auto;
    border: 1px solid #f0f0f0;
    border-radius: 6px;
    background: #fafaff;
    padding: 0.25rem;
  }
  .draft-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 0.9rem;
    border-radius: 6px;
    margin-bottom: 0.25rem;
    background: #fff;
    cursor: pointer;
    border: 1px solid transparent;
    user-select: none;
    transition: box-shadow 0.15s, border 0.15s, background 0.1s;
  }
  .draft-item.active {
    border: 1.5px solid #2679e8;
    background: #eaf2ff;
  }
  .draft-item.dragging {
    opacity: 0.5;
    background: #d5e4fa;
  }
  .draft-item.drag-over {
    border: 1.5px dashed #2679e8;
  }
  .draft-info {
    flex: 1;
  }
  .draft-title { font-weight: bold; }
  .draft-date { font-size: 0.8em; color: #888; }
  .draft-delete {
    background: none;
    border: none;
    color: #e04848;
    font-size: 1.2em;
    margin-left: 0.7em;
    cursor: pointer;
    display: flex;
    align-items: center;
  }

  /* --- Editor --- */
  .editor-container {
    flex: 1;
    min-width: 0;
    padding: 3.5rem 1.5rem 1.5rem 370px;
    transition: padding-left 0.2s;
    height: 100vh;
    box-sizing: border-box;
    position: relative;
  }
  .options-panel:not(.open) ~ .editor-container {
    padding-left: 2rem;
  }
  .editor-content {
    min-height: 70vh;
    background: #fff;
    border-radius: 10px;
    padding: 2rem;
    box-shadow: 0 4px 24px rgba(0,0,0,0.03);
    font-family: var(--editor-font);
    font-size: var(--editor-font-size);
    line-height: var(--editor-line-height);
    letter-spacing: var(--editor-letter-spacing);
    color: var(--text-color);
    outline: none;
    transition: font-family 0.2s, font-size 0.2s, color 0.2s;
    word-break: break-word;
    /* Prevent font scaling glitches */
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    resize: vertical;
    overflow: auto;
  }
  .editor-content[contenteditable="true"]:empty:before {
    content: 'Start writing your draft...';
    opacity: 0.4;
    pointer-events: none;
    font-style: italic;
    color: #8e8e8e;
  }
  .editor-content [data-color] {
    color: attr(data-color color, #181818);
  }

  /* --- Formatting Toolbar --- */
  .formatting-toolbar {
    position: absolute;
    display: none;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 16px rgba(0,0,0,0.11);
    padding: 0.3rem 0.4rem;
    z-index: 1001;
    gap: 0.3rem;
    top: 0;
    left: 0;
    flex-wrap: nowrap;
  }
  .formatting-toolbar button {
    background: none;
    border: none;
    font-size: 1.15rem;
    padding: 0.25rem 0.35rem;
    border-radius: 4px;
    cursor: pointer;
    color: #444;
    transition: background 0.12s;
  }
  .formatting-toolbar button:hover {
    background: #eaf2ff;
    color: #2679e8;
  }

  /* --- Modal --- */
  .modal {
    position: fixed;
    top: 0; left: 0; width: 100vw; height: 100vh;
    display: none;
    background: rgba(0,0,0,0.16);
    z-index: 2000;
    align-items: center;
    justify-content: center;
  }
  .modal-content {
    background: #fff;
    border-radius: 10px;
    padding: 2.5rem 2.2rem 2rem 2.2rem;
    box-shadow: 0 6px 32px rgba(0,0,0,0.11);
    min-width: 320px;
    text-align: center;
  }
  .modal-buttons {
    margin-top: 1.4rem;
    display: flex;
    justify-content: center;
    gap: 1.1rem;
  }
  .confirm-btn, .cancel-btn {
    padding: 0.6rem 1.4rem;
    border-radius: 6px;
    border: none;
    font-size: 1rem;
    cursor: pointer;
  }
  .confirm-btn { background: #2679e8; color: #fff; }
  .cancel-btn { background: #eaeaea; color: #222; }

  /* Color Picker */
  .color-picker {
    display: flex;
    align-items: center;
    gap: 0.6em;
  }
  .color-picker input[type="color"] {
    width: 32px;
    height: 32px;
    border: none;
    border-radius: 50%;
    background: none;
    cursor: pointer;
    box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  }

  /* Toggle Switch */
  .switch {
    display: inline-flex;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  .switch input { display: none; }
  .slider {
    width: 42px;
    height: 22px;
    background: #e0e0e0;
    border-radius: 22px;
    position: relative;
    margin-right: 0.6em;
    transition: background 0.2s;
  }
  .slider:before {
    content: "";
    position: absolute;
    width: 18px;
    height: 18px;
    left: 2px;
    top: 2px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    transition: transform 0.2s;
  }
  input:checked + .slider { background: #2679e8; }
  input:checked + .slider:before {
    transform: translateX(20px);
  }

  /* --- Fixes for font rendering & italics --- */
  .editor-content, .editor-content * {
    font-family: var(--editor-font);
    font-size: inherit;
    line-height: inherit;
    letter-spacing: inherit;
    color: inherit;
    /* Fix for italic/bold/italic-bold */
    font-style: inherit !important;
    font-weight: inherit !important;
  }
  .editor-content em, .editor-content i {
    font-style: italic !important;
    font-family: var(--editor-font) !important;
  }
  .editor-content strong, .editor-content b {
    font-weight: bold !important;
    font-family: var(--editor-font) !important;
  }
  .editor-content em strong, .editor-content strong em, .editor-content b i, .editor-content i b {
    font-style: italic !important;
    font-weight: bold !important;
    font-family: var(--editor-font) !important;
  }

  /* --- Search/Replace Modal --- */
  .search-modal {
    position: fixed;
    top: 0; left: 0;
    width: 100vw;
    height: 100vh;
    display: none;
    background: rgba(0,0,0,0.12);
    z-index: 3000;
    align-items: center;
    justify-content: center;
  }
  .search-modal.active {
    display: flex;
  }
  .search-modal-content {
    background: #fff;
    border-radius: 9px;
    box-shadow: 0 4px 24px rgba(0,0,0,0.13);
    min-width: 320px;
    padding: 2rem 2.2rem 1.5rem 2.2rem;
    text-align: center;
  }
  .search-modal-content input[type="text"] {
    width: 80%;
    font-size: 1.1rem;
    margin-bottom: 0.7rem;
    padding: 0.35rem 0.7rem;
    border-radius: 5px;
    border: 1px solid #e0e0e0;
    margin-top: 0.25rem;
  }
  .search-actions {
    margin-top: 0.8rem;
    display: flex;
    gap: 0.7rem;
    justify-content: center;
    align-items: center;
  }
  .search-actions button {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    background: #2679e8;
    color: #fff;
    font-size: 0.97rem;
    cursor: pointer;
    transition: background 0.17s;
  }
  .search-actions button:hover { background: #1656b7; }
  .search-actions .secondary {
    background: #eaeaea;
    color: #222;
  }

  /* --- Import Button --- */
  .import-btn {
    display: inline-block;
    margin-right: 0.5em;
    background: #eaeaea;
    color: #222;
    padding: 0.5rem 1.2rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.14s;
  }
  .import-btn:hover {
    background: #d2e3fa;
    color: #1867b7;
  }
</style>
</head>
<body>
<div class="app-container">
  <button class="options-btn" id="optionsBtn">
    <i class="fas fa-cog"></i>
  </button>
  <div class="options-panel" id="optionsPanel">
    <div class="options-header">
      <h3>Settings</h3>
    </div>
    <div class="options-content">
      <div class="option-group">
        <label class="option-label">Draft Title (Optional)</label>
        <input type="text" class="option-control" id="draftTitle" placeholder="Leave empty to auto-generate from content">
      </div>
      <div class="option-group">
        <label class="option-label">Text Size</label>
        <div class="zoom-control">
          <span>Small</span>
          <input type="range" class="zoom-slider" id="zoomSlider" min="50" max="200" value="100">
          <span class="zoom-value" id="zoomValue">100%</span>
        </div>
      </div>
      <div class="option-group">
        <label class="option-label">Text Color</label>
        <div class="color-picker">
          <input type="color" id="colorPicker" value="#181818">
          <span id="colorValue">#181818</span>
        </div>
      </div>
      <div class="option-group">
        <label class="option-label">OpenDyslexic Font</label>
        <label class="switch">
          <input type="checkbox" id="openDyslexicToggle" checked>
          <span class="slider"></span>
          <span id="fontToggleLabel">Enabled</span>
        </label>
      </div>
      <div class="option-group">
        <button class="btn primary" id="newDraft">New Draft</button>
      </div>
      <div class="option-group drafts-section">
        <label class="option-label">Drafts</label>
        <div class="drafts-list" id="draftsList"></div>
      </div>
    </div>
  </div>
  <div class="editor-container">
    <div style="display:flex; align-items: center; gap: 0.5em; margin-bottom: 0.7em; position: absolute; right: 2.5em; top: 1em; z-index: 100;">
      <button class="import-btn" id="importBtn"><i class="fas fa-file-import"></i> Import</button>
      <button class="import-btn" id="searchBtn"><i class="fas fa-search"></i> Search</button>
      <input type="file" id="importInput" accept=".md,.txt,.html" style="display:none">
    </div>
    <div class="editor-content" id="editor" contenteditable="true"></div>
  </div>
</div>
<div id="formattingToolbar" class="formatting-toolbar">
  <button data-format="bold"><i class="fas fa-bold"></i></button>
  <button data-format="italic"><i class="fas fa-italic"></i></button>
  <button data-format="h1">H1</button>
  <button data-format="h2">H2</button>
  <button data-format="h3">H3</button><!-- NEW H3 button -->
  <button data-format="blockquote"><i class="fas fa-quote-right"></i></button>
  <button data-format="code"><i class="fas fa-code"></i></button>
  <button data-format="link"><i class="fas fa-link"></i></button>
  <button data-format="color"><i class="fas fa-palette"></i></button>
</div>
<div id="confirmationModal" class="modal">
  <div class="modal-content">
    <p id="modalMessage">Are you sure?</p>
    <div class="modal-buttons">
      <button class="confirm-btn" id="modalConfirmBtn">Confirm</button>
      <button class="cancel-btn" id="modalCancelBtn">Cancel</button>
    </div>
  </div>
</div>

<!-- Search/Replace Modal -->
<div class="search-modal" id="searchModal">
  <div class="search-modal-content">
    <div>
      <label for="searchInput"><strong>Find</strong></label><br>
      <input type="text" id="searchInput" autocomplete="off" placeholder="Find...">
    </div>
    <div style="margin-top:0.8em;">
      <label for="replaceInput"><strong>Replace</strong></label><br>
      <input type="text" id="replaceInput" autocomplete="off" placeholder="Replace with...">
    </div>
    <div class="search-actions">
      <button id="findNextBtn">Find Next</button>
      <button id="replaceBtn">Replace</button>
      <button id="replaceAllBtn">Replace All</button>
      <button class="secondary" id="closeSearchModalBtn">Close</button>
    </div>
    <div style="margin-top:0.7em; font-size:0.95em;" id="searchCount"></div>
  </div>
</div>

<script>
class LiveMarkdownEditor {
  constructor() {
    this.drafts = [];
    this.currentDraftId = null;
    this.autoSaveTimer = null;
    this.localStorageKey = 'markdownEditorDrafts';
    this.initElements();
    this.bindEvents();
    this.loadDraftsFromLocalStorage();
    this.applySettingsFromLocalStorage();
    this.renderDrafts();
    this.setEditorStyles();
    this.initCustomMarkdownColors();
    this.searchIndex = -1;
    this.searchMatches = [];
    this.lastSearchTerm = '';
  }
  initElements() {
    this.editor = document.getElementById('editor');
    this.optionsPanel = document.getElementById('optionsPanel');
    this.draftsList = document.getElementById('draftsList');
    this.draftTitle = document.getElementById('draftTitle');
    this.optionsBtn = document.getElementById('optionsBtn');
    this.zoomSlider = document.getElementById('zoomSlider');
    this.zoomValue = document.getElementById('zoomValue');
    this.newDraftBtn = document.getElementById('newDraft');
    this.formattingToolbar = document.getElementById('formattingToolbar');
    this.confirmationModal = document.getElementById('confirmationModal');
    this.modalMessage = document.getElementById('modalMessage');
    this.modalConfirmBtn = document.getElementById('modalConfirmBtn');
    this.modalCancelBtn = document.getElementById('modalCancelBtn');
    this.colorPicker = document.getElementById('colorPicker');
    this.colorValue = document.getElementById('colorValue');
    this.openDyslexicToggle = document.getElementById('openDyslexicToggle');
    this.fontToggleLabel = document.getElementById('fontToggleLabel');
    this.importBtn = document.getElementById('importBtn');
    this.importInput = document.getElementById('importInput');
    this.searchBtn = document.getElementById('searchBtn');
    this.searchModal = document.getElementById('searchModal');
    this.searchInput = document.getElementById('searchInput');
    this.replaceInput = document.getElementById('replaceInput');
    this.findNextBtn = document.getElementById('findNextBtn');
    this.replaceBtn = document.getElementById('replaceBtn');
    this.replaceAllBtn = document.getElementById('replaceAllBtn');
    this.closeSearchModalBtn = document.getElementById('closeSearchModalBtn');
    this.searchCount = document.getElementById('searchCount');
  }
  bindEvents() {
    document.addEventListener('click', (e) => {
      if (!this.optionsPanel.contains(e.target) && !this.optionsBtn.contains(e.target)) {
        this.optionsPanel.classList.remove('open');
        this.optionsBtn.innerHTML = '<i class="fas fa-cog"></i>';
      }
    });
    this.optionsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isPanelOpen = this.optionsPanel.classList.toggle('open');
      this.optionsBtn.innerHTML = isPanelOpen
        ? '<i class="fas fa-times"></i>'
        : '<i class="fas fa-cog"></i>';
    });
    this.zoomSlider.addEventListener('input', () => {
      this.zoomValue.textContent = `${this.zoomSlider.value}%`;
      localStorage.setItem('mdw_zoom', this.zoomSlider.value);
      this.setEditorStyles();
    });
    this.colorPicker.addEventListener('input', () => {
      this.colorValue.textContent = this.colorPicker.value;
      localStorage.setItem('mdw_text_color', this.colorPicker.value);
      this.setEditorStyles();
    });
    this.openDyslexicToggle.addEventListener('change', () => {
      localStorage.setItem('mdw_opendyslexic', this.openDyslexicToggle.checked ? 'on' : 'off');
      this.fontToggleLabel.textContent = this.openDyslexicToggle.checked ? 'Enabled' : 'Disabled';
      this.setEditorStyles();
      this.applyFontToDocument();
    });
    this.draftTitle.addEventListener('input', () => this.scheduleAutoSave());
    this.newDraftBtn.addEventListener('click', () => this.createNewDraft());
    this.editor.addEventListener('input', () => {
      this.scheduleAutoSave();
      this.updateCustomColorSpans();
      // remove search highlights if editing
      if (this.searchModal.classList.contains('active')) {
        this.clearSearchHighlights();
        this.updateSearchMatches();
      }
    });
    this.editor.addEventListener('mouseup', () => this.handleSelectionChange());
    this.editor.addEventListener('keyup', (e) => {
      this.handleSelectionChange();
    });
    document.addEventListener('selectionchange', () => this.handleSelectionChange());
    document.addEventListener('scroll', () => this.hideToolbar());
    document.addEventListener('mousedown', (e) => {
      if (!this.formattingToolbar.contains(e.target)) this.hideToolbar();
    });
    this.formattingToolbar.addEventListener('mousedown', (e) => {
      e.preventDefault();
    });
    this.formattingToolbar.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (btn) {
        const format = btn.dataset.format;
        if (format === 'color') {
          this.openColorPrompt();
        } else {
          this.applyFormat(format);
        }
        this.hideToolbar();
      }
    });
    this.modalConfirmBtn.addEventListener('click', () => {
      this.modalPromiseResolve(true);
      this.confirmationModal.style.display = 'none';
    });
    this.modalCancelBtn.addEventListener('click', () => {
      this.modalPromiseResolve(false);
      this.confirmationModal.style.display = 'none';
    });
    // Import/Export
    this.importBtn.addEventListener('click', () => {
      this.importInput.value = '';
      this.importInput.click();
    });
    this.importInput.addEventListener('change', (e) => {
      if (this.importInput.files && this.importInput.files.length > 0) {
        const file = this.importInput.files[0];
        const reader = new FileReader();
        reader.onload = (ev) => {
          this.importFileContent(ev.target.result, file.name);
        };
        reader.readAsText(file);
      }
    });
    // Search/Replace Modal
    this.searchBtn.addEventListener('click', () => {
      this.showSearchModal();
    });
    this.closeSearchModalBtn.addEventListener('click', () => {
      this.hideSearchModal();
    });
    this.findNextBtn.addEventListener('click', () => {
      this.findNext();
    });
    this.replaceBtn.addEventListener('click', () => {
      this.replaceCurrent();
    });
    this.replaceAllBtn.addEventListener('click', () => {
      this.replaceAll();
    });
    this.searchInput.addEventListener('input', () => {
      this.updateSearchMatches();
    });
    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'f' && !this.searchModal.classList.contains('active')) {
        e.preventDefault();
        this.showSearchModal();
      } else if (e.key === "Escape" && this.searchModal.classList.contains('active')) {
        this.hideSearchModal();
      }
    });
  }
  setEditorStyles() {
    // Font size
    const zoom = this.zoomSlider.value || 100;
    document.documentElement.style.setProperty('--editor-font-size', `${zoom / 100 * 1.1}rem`);
    // Text color
    const color = this.colorPicker.value || '#181818';
    document.documentElement.style.setProperty('--text-color', color);
    // Font
    const useDyslexic = this.openDyslexicToggle.checked;
    document.documentElement.style.setProperty('--editor-font',
      useDyslexic ? "'OpenDyslexic', Arial, sans-serif" : "Arial, sans-serif"
    );
    this.applyFontToDocument();
  }
  applyFontToDocument() {
    // Actually applies the font to the document (editor content)
    // Only target the content inside the editor, not the UI
    if (this.openDyslexicToggle.checked) {
      this.editor.classList.add('dyslexic-font');
      this.editor.style.fontFamily = "'OpenDyslexic', Arial, sans-serif";
    } else {
      this.editor.classList.remove('dyslexic-font');
      this.editor.style.fontFamily = "Arial, sans-serif";
    }
    // Also update children spans that may have inherited previous font
    for (const el of this.editor.querySelectorAll('[data-color]')) {
      el.style.fontFamily = this.editor.style.fontFamily;
    }
  }
  applySettingsFromLocalStorage() {
    if (localStorage.getItem('mdw_zoom')) {
      this.zoomSlider.value = localStorage.getItem('mdw_zoom');
      this.zoomValue.textContent = `${this.zoomSlider.value}%`;
    }
    if (localStorage.getItem('mdw_text_color')) {
      this.colorPicker.value = localStorage.getItem('mdw_text_color');
      this.colorValue.textContent = this.colorPicker.value;
    }
    if (localStorage.getItem('mdw_opendyslexic')) {
      this.openDyslexicToggle.checked = localStorage.getItem('mdw_opendyslexic') === 'on';
      this.fontToggleLabel.textContent = this.openDyslexicToggle.checked ? 'Enabled' : 'Disabled';
    }
    this.setEditorStyles();
  }
  handleSelectionChange() {
    // Delay before showing toolbar to avoid double-click accidental tap
    clearTimeout(this.toolbarShowTimeout);
    this.toolbarShowTimeout = setTimeout(() => {
      const selection = window.getSelection();
      if (!selection.rangeCount) return this.hideToolbar();
      const range = selection.getRangeAt(0);
      if (!selection.isCollapsed && this.editor.contains(range.startContainer) && this.editor.contains(range.endContainer)) {
        const rect = range.getBoundingClientRect();
        let toolbarLeft = rect.left + window.scrollX - this.formattingToolbar.offsetWidth / 2 + rect.width / 2;
        let toolbarTop = rect.bottom + window.scrollY + 8; // Show BELOW selection
        // Clamp within window
        if (toolbarLeft < window.scrollX + 10) toolbarLeft = window.scrollX + 10;
        if (toolbarLeft + this.formattingToolbar.offsetWidth > window.innerWidth - 10)
          toolbarLeft = window.innerWidth - this.formattingToolbar.offsetWidth - 10;
        // If too far down, show above as fallback
        if (toolbarTop + this.formattingToolbar.offsetHeight > window.innerHeight - 20) {
          toolbarTop = rect.top + window.scrollY - this.formattingToolbar.offsetHeight - 8;
        }
        this.formattingToolbar.style.display = 'flex';
        this.formattingToolbar.style.left = `${toolbarLeft}px`;
        this.formattingToolbar.style.top = `${toolbarTop}px`;
      } else {
        this.hideToolbar();
      }
    }, 80);
  }
  hideToolbar() {
    this.formattingToolbar.style.display = 'none';
  }
  applyFormat(command) {
    this.editor.focus();
    switch (command) {
      case 'bold':
        document.execCommand('bold', false, null);
        break;
      case 'italic':
        document.execCommand('italic', false, null);
        break;
      case 'h1':
        document.execCommand('formatBlock', false, 'H1');
        break;
      case 'h2':
        document.execCommand('formatBlock', false, 'H2');
        break;
      case 'h3':
        document.execCommand('formatBlock', false, 'H3');
        break;
      case 'blockquote':
        document.execCommand('formatBlock', false, 'BLOCKQUOTE');
        break;
      case 'code':
        this.toggleCode();
        break;
      case 'link':
        const url = prompt('Enter the URL:', 'https://');
        if (url) document.execCommand('createLink', false, url);
        break;
      default:
        console.warn('Unknown format command:', command);
        break;
    }
    this.scheduleAutoSave();
  }
  openColorPrompt() {
    // Open a prompt for color hex, then wrap selected text with <span data-color="#hex">
    setTimeout(() => {
      let color = prompt('Enter hex color (e.g. #ed6e0c):', '#');
      if (!color || !/^#([0-9a-fA-F]{3,8})$/.test(color.trim())) {
        return;
      }
      color = color.trim();
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      const range = selection.getRangeAt(0);
      if (!range || range.collapsed) return;
      // Wrap in span
      const span = document.createElement('span');
      span.setAttribute('data-color', color);
      span.style.color = color;
      // Fix font for OpenDyslexic
      span.style.fontFamily = this.openDyslexicToggle.checked
        ? "'OpenDyslexic', Arial, sans-serif"
        : "Arial, sans-serif";
      span.appendChild(range.extractContents());
      range.insertNode(span);
      // Move cursor after span
      selection.removeAllRanges();
      const newRange = document.createRange();
      newRange.setStartAfter(span);
      newRange.collapse(true);
      selection.addRange(newRange);
      this.scheduleAutoSave();
    }, 50);
  }
  toggleCode() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    const range = selection.getRangeAt(0);
    const parentCode = this.findParentTag(range.commonAncestorContainer, 'CODE');
    if (parentCode) {
      // Toggle off code
      const fragment = document.createDocumentFragment();
      while (parentCode.firstChild) fragment.appendChild(parentCode.firstChild);
      parentCode.parentNode.replaceChild(fragment, parentCode);
    } else {
      // Toggle on code
      const codeNode = document.createElement('code');
      codeNode.appendChild(range.extractContents());
      range.insertNode(codeNode);
      selection.removeAllRanges();
      const newRange = document.createRange();
      newRange.selectNodeContents(codeNode);
      selection.addRange(newRange);
    }
  }
  findParentTag(node, tagName) {
    while (node && node !== this.editor) {
      if (node.nodeType === 1 && node.tagName === tagName) return node;
      node = node.parentNode;
    }
    return null;
  }
  placeCursorAtEnd() {
    const selection = window.getSelection();
    const range = document.createRange();
    if (this.editor.lastChild) {
      range.setStartAfter(this.editor.lastChild);
    } else {
      range.setStart(this.editor, 0);
    }
    range.collapse(true);
    selection.removeAllRanges();
    selection.addRange(range);
  }
  scheduleAutoSave() {
    clearTimeout(this.autoSaveTimer);
    this.autoSaveTimer = setTimeout(() => {
      this.saveDraft();
      this.saveDraftsToLocalStorage();
    }, 1000);
  }
  createNewDraft() {
    this.saveDraft();
    const draft = {
      id: Date.now(),
      title: '',
      content: '',
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
    this.drafts.unshift(draft);
    this.loadDraft(draft.id);
    this.renderDrafts();
    this.saveDraftsToLocalStorage();
    this.editor.innerHTML = '';
    this.placeCursorAtEnd();
  }
  loadDraft(id) {
    const draft = this.drafts.find(d => d.id === id);
    if (draft) {
      this.currentDraftId = id;
      this.draftTitle.value = draft.title;
      this.editor.innerHTML = draft.content;
      this.updateCustomColorSpans();
      this.renderDrafts();
      this.placeCursorAtEnd();
    }
  }
  saveDraft() {
    if (!this.currentDraftId) return;
    const draft = this.drafts.find(d => d.id === this.currentDraftId);
    if (draft) {
      const content = this.editor.innerHTML || '';
      draft.content = content;
      draft.updatedAt = new Date().toISOString();
      draft.title = this.draftTitle.value.trim() || this.generateTitleFromContent(this.editor.textContent || '');
    }
  }
  generateTitleFromContent(content) {
    if (!content.trim()) return 'Untitled Draft';
    const firstLine = content.split('\n')[0] || '';
    return firstLine.substring(0, 20) + (firstLine.length > 20 ? '...' : '') || 'Untitled Draft';
  }
  showConfirmationModal(message) {
    this.modalMessage.textContent = message;
    this.confirmationModal.style.display = 'flex';
    return new Promise((resolve) => {
      this.modalPromiseResolve = resolve;
    });
  }
  async deleteDraft(id) {
    const confirmed = await this.showConfirmationModal('Are you sure you want to delete this draft?');
    if (confirmed) {
      this.drafts = this.drafts.filter(d => d.id !== id);
      if (this.currentDraftId === id) {
        if (this.drafts.length > 0) {
          this.loadDraft(this.drafts[0].id);
        } else {
          this.currentDraftId = null;
          this.draftTitle.value = '';
          this.editor.innerHTML = '';
        }
      }
      this.renderDrafts();
      this.saveDraftsToLocalStorage();
    }
  }
  renderDrafts() {
    this.draftsList.innerHTML = '';
    if (this.drafts.length === 0) {
      this.draftsList.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No drafts</div>';
      return;
    }
    this.drafts.forEach((draft, i) => {
      const draftEl = document.createElement('div');
      draftEl.className = `draft-item${draft.id === this.currentDraftId ? ' active' : ''}`;
      draftEl.setAttribute('draggable', true);
      draftEl.dataset.index = i;
      draftEl.dataset.id = draft.id;

      // --- Draft Info ---
      const infoDiv = document.createElement('div');
      infoDiv.className = 'draft-info';
      infoDiv.innerHTML = `
        <span class="draft-title">${draft.title || 'Untitled Draft'}</span>
        <br>
        <span class="draft-date">${new Date(draft.updatedAt).toLocaleString()}</span>
      `;
      // Clicking info opens draft
      infoDiv.addEventListener('click', (e) => {
        this.saveDraft();
        this.loadDraft(draft.id);
      });

      // --- Delete Button ---
      const delBtn = document.createElement('button');
      delBtn.className = 'draft-delete';
      delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        this.deleteDraft(draft.id);
      });

      draftEl.appendChild(infoDiv);
      draftEl.appendChild(delBtn);

      // --- Drag and Drop Handlers ---
      draftEl.addEventListener('dragstart', (e) => {
        draftEl.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', i);
      });
      draftEl.addEventListener('dragend', (e) => {
        draftEl.classList.remove('dragging');
        this.renderDrafts();
      });
      draftEl.addEventListener('dragover', (e) => {
        e.preventDefault();
        const dragging = this.draftsList.querySelector('.dragging');
        if (dragging !== draftEl) draftEl.classList.add('drag-over');
      });
      draftEl.addEventListener('dragleave', (e) => {
        draftEl.classList.remove('drag-over');
      });
      draftEl.addEventListener('drop', (e) => {
        e.preventDefault();
        draftEl.classList.remove('drag-over');
        const fromIndex = parseInt(e.dataTransfer.getData('text/plain'), 10);
        const toIndex = i;
        this.moveDraft(fromIndex, toIndex);
      });

      this.draftsList.appendChild(draftEl);
    });
  }
  moveDraft(from, to) {
    if (from === to) return;
    const draft = this.drafts.splice(from, 1)[0];
    this.drafts.splice(to, 0, draft);
    this.saveDraftsToLocalStorage();
    this.renderDrafts();
  }
  saveDraftsToLocalStorage() {
    try {
      const serializableDrafts = this.drafts.map(draft => ({
        ...draft,
        createdAt: draft.createdAt instanceof Date ? draft.createdAt.toISOString() : draft.createdAt,
        updatedAt: draft.updatedAt instanceof Date ? draft.updatedAt.toISOString() : draft.updatedAt,
      }));
      localStorage.setItem(this.localStorageKey, JSON.stringify(serializableDrafts));
    } catch (err) {
      // handle silently
    }
  }
  loadDraftsFromLocalStorage() {
    try {
      const storedDrafts = localStorage.getItem(this.localStorageKey);
      if (storedDrafts) {
        this.drafts = JSON.parse(storedDrafts).map(draft => ({
          ...draft,
          createdAt: new Date(draft.createdAt),
          updatedAt: new Date(draft.updatedAt)
        }));
        if (this.drafts.length > 0) {
          this.currentDraftId = this.drafts[0].id;
          this.draftTitle.value = this.drafts[0].title;
          this.editor.innerHTML = this.drafts[0].content;
          this.updateCustomColorSpans();
        }
      }
    } catch (err) {
      // handle silently
    }
  }
  // --- Custom Markdown Color Syntax ---
  initCustomMarkdownColors() {
    this.updateCustomColorSpans();
  }
  updateCustomColorSpans() {
    // Convert <#hex>text</> in editor to <span data-color="#hex">text</span>
    if (!this.editor) return;
    // Only if actually .innerHTML uses the custom syntax (not inside tags)
    let html = this.editor.innerHTML;
    // Replace only outside tags (not already inside span)
    // Regex: <#([0-9a-fA-F]{3,8})>((?:(?!<\/>).)*?)<\/>
    html = html.replace(/&lt;#([0-9a-fA-F]{3,8})&gt;([\s\S]*?)&lt;\/&gt;/g, (m, hex, text) =>
      `<span data-color="#${hex}" style="color:#${hex};">${text}</span>`
    );
    html = html.replace(/<#([0-9a-fA-F]{3,8})>([\s\S]*?)<\/>/g, (m, hex, text) =>
      `<span data-color="#${hex}" style="color:#${hex};">${text}</span>`
    );
    // If html changed, update and keep caret
    if (html !== this.editor.innerHTML) {
      const sel = window.getSelection();
      const pos = sel.anchorOffset;
      this.editor.innerHTML = html;
      this.restoreCaret(pos);
    }
    // Enforce font family on color spans
    for (const el of this.editor.querySelectorAll('[data-color]')) {
      el.style.fontFamily = this.openDyslexicToggle.checked
        ? "'OpenDyslexic', Arial, sans-serif"
        : "Arial, sans-serif";
    }
  }
  restoreCaret(pos) {
    // (Simple restore for single node)
    try {
      const selection = window.getSelection();
      if (this.editor.childNodes.length === 0) return;
      let node = this.editor.childNodes[0];
      let offset = Math.min(pos, node.textContent.length);
      selection.removeAllRanges();
      const range = document.createRange();
      range.setStart(node, offset);
      range.collapse(true);
      selection.addRange(range);
    } catch (e) {}
  }
  // --- Import .md/.txt/.html ---
  importFileContent(content, filename) {
    if (filename.endsWith('.md') || filename.endsWith('.txt')) {
      // Treat as plain text, escape HTML, try to convert color syntax
      // Convert <#hex>text</> to color spans
      content = content.replace(/<#([0-9a-fA-F]{3,8})>([\s\S]*?)<\/>/g, (m, hex, text) =>
        `<span data-color="#${hex}" style="color:#${hex};">${text}</span>`
      );
      // Escape lines except for our color spans
      content = content.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      content = content.replace(/&lt;span data-color=/g, '<span data-color=').replace(/&lt;\/span&gt;/g, '</span>');
      this.editor.innerHTML = content.replace(/\n/g, "<br>");
    } else if (filename.endsWith('.html')) {
      // Try to set as HTML, but only allow certain tags (whitelist)
      // Whitelist: h1-h6, p, span[data-color], code, b, i, em, strong, blockquote, ul, ol, li, br
      const temp = document.createElement('div');
      temp.innerHTML = content;
      // Remove scripts/styles
      for (const script of temp.querySelectorAll('script,style')) script.remove();
      // Remove all attributes except data-color and style for span, href for a
      for (const el of temp.querySelectorAll('*')) {
        if (el.tagName.toLowerCase() === 'span') {
          for (const attr of Array.from(el.attributes)) {
            if (attr.name !== 'data-color' && attr.name !== 'style') el.removeAttribute(attr.name);
          }
        } else if (el.tagName.toLowerCase() === 'a') {
          for (const attr of Array.from(el.attributes)) {
            if (attr.name !== 'href') el.removeAttribute(attr.name);
          }
        } else if (!['h1','h2','h3','h4','h5','h6','p','span','code','b','i','em','strong','blockquote','ul','ol','li','br','a'].includes(el.tagName.toLowerCase())) {
          el.replaceWith(document.createTextNode(el.outerHTML));
        }
      }
      this.editor.innerHTML = temp.innerHTML;
    }
    this.updateCustomColorSpans();
    this.scheduleAutoSave();
  }
  // --- Search/Replace ---
  showSearchModal() {
    this.searchModal.classList.add('active');
    setTimeout(() => this.searchInput.focus(), 70);
    this.updateSearchMatches();
  }
  hideSearchModal() {
    this.clearSearchHighlights();
    this.searchModal.classList.remove('active');
  }
  updateSearchMatches() {
    this.clearSearchHighlights();
    this.searchIndex = -1;
    this.searchMatches = [];
    const searchVal = this.searchInput.value;
    if (!searchVal) {
      this.searchCount.textContent = '';
      return;
    }
    // Search in plain text and mark matches in HTML
    const walker = document.createTreeWalker(this.editor, NodeFilter.SHOW_TEXT, null, false);
    let node, matches = [];
    while ((node = walker.nextNode())) {
      let idx = -1, from = 0;
      const t = node.textContent;
      while ((idx = t.toLowerCase().indexOf(searchVal.toLowerCase(), from)) !== -1) {
        matches.push({
          node,
          start: idx,
          end: idx+searchVal.length
        });
        from = idx + searchVal.length;
      }
    }
    // Mark matches
    for (let i = matches.length-1; i >= 0; --i) {
      const m = matches[i];
      const n = m.node;
      const before = n.textContent.slice(0, m.start);
      const match = n.textContent.slice(m.start, m.end);
      const after = n.textContent.slice(m.end);
      const span = document.createElement('span');
      span.className = 'search-match';
      span.style.background = '#ffe869';
      span.textContent = match;
      const frag = document.createDocumentFragment();
      if (before) frag.appendChild(document.createTextNode(before));
      frag.appendChild(span);
      if (after) frag.appendChild(document.createTextNode(after));
      n.parentNode.replaceChild(frag, n);
    }
    // Gather all spans
    this.searchMatches = Array.from(this.editor.querySelectorAll('.search-match'));
    this.searchCount.textContent = this.searchMatches.length
      ? `Match ${this.searchIndex+1||1} of ${this.searchMatches.length}`
      : 'No matches';
    if (this.searchMatches.length) {
      this.searchIndex = 0;
      this.scrollToMatch(this.searchIndex);
      this.highlightCurrentMatch();
    }
  }
  clearSearchHighlights() {
    // Remove all .search-match spans
    const matches = this.editor.querySelectorAll('.search-match');
    for (const match of matches) {
      const text = document.createTextNode(match.textContent);
      match.parentNode.replaceChild(text, match);
    }
  }
  findNext() {
    if (!this.searchMatches.length) return;
    this.removeCurrentMatchHighlight();
    this.searchIndex = (this.searchIndex + 1) % this.searchMatches.length;
    this.scrollToMatch(this.searchIndex);
    this.highlightCurrentMatch();
    this.searchCount.textContent = `Match ${this.searchIndex+1} of ${this.searchMatches.length}`;
  }
  replaceCurrent() {
    if (!this.searchMatches.length) return;
    const span = this.searchMatches[this.searchIndex];
    const replaceVal = this.replaceInput.value || '';
    const text = document.createTextNode(replaceVal);
    span.parentNode.replaceChild(text, span);
    this.updateSearchMatches();
  }
  replaceAll() {
    if (!this.searchMatches.length) return;
    const replaceVal = this.replaceInput.value || '';
    for (const span of this.searchMatches) {
      const text = document.createTextNode(replaceVal);
      span.parentNode.replaceChild(text, span);
    }
    this.updateSearchMatches();
  }
  scrollToMatch(index) {
    if (!this.searchMatches.length) return;
    const span = this.searchMatches[index];
    span.scrollIntoView({block: "center", behavior: "smooth"});
  }
  highlightCurrentMatch() {
    if (!this.searchMatches.length) return;
    const span = this.searchMatches[this.searchIndex];
    span.style.background = '#ffb969';
  }
  removeCurrentMatchHighlight() {
    if (!this.searchMatches.length) return;
    const span = this.searchMatches[this.searchIndex];
    span.style.background = '#ffe869';
  }
  // --- Export (for color tags) ---
  getExportedText(type='md') {
    // Remove color spans for .md/.txt exports, replacing with just text
    let html = this.editor.innerHTML;
    // Remove <span data-color="#...">...</span>
    html = html.replace(/<span data-color="#[0-9a-fA-F]{3,8}"[^>]*>([\s\S]*?)<\/span>/g, '$1');
    if (type === 'txt') {
      // Remove all tags
      let div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent;
    } else if (type === 'md') {
      // Could convert common blocks to markdown, but for now output text content
      let div = document.createElement('div');
      div.innerHTML = html;
      return div.textContent;
    }
    return html;
  }
}
document.addEventListener('DOMContentLoaded', () => {
  new LiveMarkdownEditor();
});
</script>
</body>
</html>
