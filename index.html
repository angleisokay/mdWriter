@<!doctype html>
<html lang=en>
<head>
<meta charset=UTF-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Markdown Editor</title>
<link href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css rel=stylesheet>
<style>@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Regular.otf') format('opentype');font-weight:400;font-style:normal}@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold.otf') format('opentype');font-weight:700;font-style:normal}@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Italic.otf') format('opentype');font-weight:400;font-style:italic}@font-face{font-family:OpenDyslexic;src:url('./opendyslexic-0.91.12/compiled/OpenDyslexic-Bold-Italic.otf') format('opentype');font-weight:700;font-style:italic}:root{--bg-primary:#0d1117;--bg-secondary:#161b22;--bg-tertiary:#21262d;--text-primary:#f0f6fc;--text-secondary:#7d8590;--accent:#58a6ff;--accent-hover:#388bfd;--border:#30363d;--success:#238636;--danger:#da3633;--font-family:Arial,sans-serif}body.light-mode{--bg-primary:#ffffff;--bg-secondary:#f6f8fa;--bg-tertiary:#e1e4e8;--text-primary:#24292e;--text-secondary:#586069;--accent:#0366d6;--accent-hover:#005cc5;--border:#d1d5da;--success:#28a745;--danger:#cb2431}*{margin:0;padding:0;box-sizing:border-box}body{font-family:var(--font-family);background:var(--bg-primary);color:var(--text-primary);height:100vh;overflow:hidden;transition:background .3s ease,color .3s ease}body.use-opendyslexic{font-family:OpenDyslexic,Arial,sans-serif}.app-container{display:flex;height:100vh;position:relative}.options-btn{position:fixed;top:20px;right:20px;z-index:1000;background:var(--bg-secondary);border:1px solid var(--border);color:var(--text-primary);padding:12px;border-radius:50%;cursor:pointer;font-size:16px;transition:all .2s ease;box-shadow:0 4px 12px rgba(0,0,0,.3);width:44px;height:44px;display:flex;align-items:center;justify-content:center}.options-btn:hover{background:var(--accent);border-color:var(--accent)}.options-panel{position:fixed;top:0;right:-400px;width:400px;height:100vh;background:var(--bg-secondary);border-left:1px solid var(--border);transition:right .3s ease;z-index:999;display:flex;flex-direction:column;box-shadow:-4px 0 12px rgba(0,0,0,.3)}.options-panel.open{right:0}.options-header{padding:20px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}.options-content{flex:1;padding:20px;overflow-y:auto}.option-group{margin-bottom:24px}.option-label{display:block;margin-bottom:8px;font-weight:700;color:var(--text-primary)}.option-control{width:100%;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:12px;border-radius:6px;font-family:inherit;font-size:14px;transition:background .3s ease,border-color .3s ease,color .3s ease}.option-control:focus{outline:0;border-color:var(--accent)}.zoom-control{display:flex;align-items:center;gap:12px}.zoom-slider{flex:1;accent-color:var(--accent)}.zoom-value{min-width:50px;text-align:center;font-weight:700}.drafts-section{flex:1}.drafts-list{max-height:300px;overflow-y:auto;border:1px solid var(--border);border-radius:6px;background:var(--bg-tertiary)}.draft-item{padding:12px;border-bottom:1px solid var(--border);cursor:grab;transition:background .2s ease;position:relative}.draft-item:last-child{border-bottom:0}.draft-item:hover{background:var(--bg-primary)}.draft-item.active{background:var(--accent);color:#fff}.draft-item.dragging{opacity:.5;border:2px dashed var(--accent)}.draft-title{font-weight:700;margin-bottom:4px}.draft-preview{font-size:12px;color:var(--text-secondary);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.draft-item.active .draft-preview{color:rgba(255,255,255,.8)}.draft-actions{margin-top:8px;display:flex;gap:8px;justify-content:flex-end}.draft-btn{background:var(--bg-primary);border:1px solid var(--border);color:var(--text-secondary);padding:4px 8px;border-radius:4px;cursor:pointer;font-size:12px}.draft-btn:hover{color:var(--text-primary);border-color:var(--accent)}.btn{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:12px 16px;border-radius:6px;cursor:pointer;font-family:inherit;font-size:14px;transition:all .2s ease}.btn:hover{background:var(--accent);border-color:var(--accent)}.btn.primary{background:var(--success);border-color:var(--success)}.btn.primary:hover{background:#2ea043}.editor-container{flex:1;display:flex;flex-direction:column;position:relative}.editor-content{flex:1;background:var(--bg-primary);color:var(--text-primary);border:0;padding:40px;font-family:inherit;font-size:16px;line-height:1.6;letter-spacing:0;outline:0;overflow-y:auto;min-height:100%;word-wrap:break-word;white-space:pre-wrap}.editor-content:empty::before{content:"Start typing here... Highlight text to format!";color:var(--text-secondary);font-style:italic}.editor-content h1{font-size:2em;font-weight:700;margin:.5em 0;color:var(--accent);border-bottom:2px solid var(--border);padding-bottom:.3em;display:block}.editor-content h2{font-size:1.7em;font-weight:700;margin:.5em 0;color:var(--accent);border-bottom:1px solid var(--border);padding-bottom:.2em;display:block}.editor-content h3{font-size:1.4em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content h4{font-size:1.2em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content h5{font-size:1.1em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content h6{font-size:1em;font-weight:700;margin:.5em 0;color:var(--accent);display:block}.editor-content strong{font-weight:700;color:var(--text-primary)}.editor-content em{font-style:italic;color:#ffa657}.editor-content code{background:var(--bg-tertiary);padding:2px 6px;border-radius:4px;font-family:'Courier New',monospace;font-size:.9em;color:#f97583}.editor-content pre{background:var(--bg-tertiary);padding:16px;border-radius:8px;margin:1em 0;overflow-x:auto;font-family:'Courier New',monospace;font-size:.9em;color:#f97583}.editor-content blockquote{border-left:4px solid var(--accent);padding-left:16px;margin:1em 0;color:var(--text-secondary);font-style:italic;background:rgba(88,166,255,.05);padding:16px;border-radius:0 6px 6px 0;display:block}.editor-content ol,.editor-content ul{padding-left:24px;margin:1em 0}.editor-content li{margin:.5em 0}.markdown-syntax{color:var(--text-secondary);font-size:.8em}.modal{display:none;position:fixed;z-index:1001;left:0;top:0;width:100%;height:100%;overflow:auto;background-color:rgba(0,0,0,.6);justify-content:center;align-items:center}.modal-content{background-color:var(--bg-secondary);margin:auto;padding:20px;border:1px solid var(--border);border-radius:8px;width:80%;max-width:400px;box-shadow:0 5px 15px rgba(0,0,0,.5);text-align:center}.modal-content p{margin-bottom:20px;color:var(--text-primary)}.modal-buttons{display:flex;justify-content:space-around;gap:10px}.modal-buttons button{flex:1;padding:10px 15px;border-radius:5px;cursor:pointer;font-family:inherit;font-size:14px;transition:background .2s ease}.modal-buttons .confirm-btn{background-color:var(--danger);color:#fff;border:1px solid var(--danger)}.modal-buttons .confirm-btn:hover{background-color:#b32d2c}.modal-buttons .cancel-btn{background-color:var(--bg-tertiary);color:var(--text-primary);border:1px solid var(--border)}.modal-buttons .cancel-btn:hover{background-color:var(--bg-primary)}.formatting-toolbar{display:none;position:absolute;background:var(--bg-secondary);border:1px solid var(--border);border-radius:8px;padding:8px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1000;gap:5px;flex-wrap:wrap;align-items:center}.formatting-toolbar button,.formatting-toolbar input[type=color]{background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:8px 12px;border-radius:5px;cursor:pointer;font-size:14px;transition:background .2s,border-color .2s;-webkit-appearance:none;-moz-appearance:none;appearance:none;width:40px;height:40px;padding:0}.formatting-toolbar button:hover,.formatting-toolbar input[type=color]:hover{background:var(--accent);border-color:var(--accent)}.formatting-toolbar input[type=color]::-webkit-color-swatch-wrapper{padding:0}.formatting-toolbar input[type=color]::-webkit-color-swatch{border:none;border-radius:4px}.formatting-toolbar input[type=color]::-moz-color-swatch-wrapper{padding:0}.formatting-toolbar input[type=color]::-moz-color-swatch{border:none;border-radius:4px}.search-replace-bar{position:absolute;bottom:0;left:0;right:0;background:var(--bg-secondary);border-top:1px solid var(--border);padding:10px 20px;display:flex;gap:10px;align-items:center;z-index:990;transform:translateY(100%);transition:transform .3s ease-out}.search-replace-bar.open{transform:translateY(0)}.search-replace-bar input{flex:1;background:var(--bg-tertiary);border:1px solid var(--border);color:var(--text-primary);padding:8px 12px;border-radius:6px;font-family:inherit;font-size:14px}.search-replace-bar button{background:var(--accent);border:1px solid var(--accent);color:#fff;padding:8px 12px;border-radius:6px;cursor:pointer;font-size:14px;transition:background .2s ease}.search-replace-bar button:hover{background:var(--accent-hover);border-color:var(--accent-hover)}.search-replace-bar .close-btn{background:0 0;border:none;color:var(--text-secondary);font-size:20px;cursor:pointer;padding:0 5px}.search-replace-bar .close-btn:hover{color:var(--text-primary)}.highlight{background-color:rgba(255,255,0,.5);border-radius:2px}#fileInput{display:none}@media(max-width:768px){.options-panel{width:100vw;right:-100vw}.editor-content{padding:20px;font-size:14px}.formatting-toolbar{flex-direction:row;flex-wrap:wrap;max-width:90vw}.search-replace-bar{flex-wrap:wrap;justify-content:center}.search-replace-bar button,.search-replace-bar input{width:100%}}</style>
</head>
<body>
<div class=app-container>
<button class=options-btn id=optionsBtn>
<i class="fas fa-cog"></i>
</button>
<div class=options-panel id=optionsPanel>
<div class=options-header>
<h3>Settings</h3>
</div>
<div class=options-content>
<div class=option-group>
<label class=option-label>Draft Title (Optional)</label>
<input class=option-control id=draftTitle placeholder="Leave empty to auto-generate from content">
</div>
<div class=option-group>
<label class=option-label>Text Size</label>
<div class=zoom-control>
<span>Small</span>
<input type=range class=zoom-slider id=zoomSlider min=50 max=200 value=100>
<span class=zoom-value id=zoomValue>100%</span>
</div>
</div>
<div class=option-group>
<label class=option-label>Font Preference</label>
<input type=checkbox id=toggleOpenDyslexic> Use OpenDyslexic Font
</div>
<div class=option-group>
<label class=option-label>Theme</label>
<input type=checkbox id=toggleLightMode> Light Mode
</div>
<div class=option-group>
<button class="btn primary" id=newDraft>New Draft</button>
</div>
<div class="option-group drafts-section">
<label class=option-label>Drafts</label>
<div class=drafts-list id=draftsList>
</div>
</div>
<div class=option-group>
<label class=option-label>Import File</label>
<input type=file id=fileInput accept=.md,.html,.txt>
<button class=btn id=importFileBtn>Import File</button>
</div>
<div class=option-group>
<label class=option-label>Download Options</label>
<button class=btn id=downloadMarkdown>Download .md</button>
<button class=btn id=downloadHTML>Download .html</button>
<button class=btn id=downloadTXT>Download .txt</button>
</div>
</div>
</div>
<div class=editor-container>
<div class=editor-content id=editor contenteditable=true></div>
<div class=search-replace-bar id=searchReplaceBar>
<input id=searchTerm placeholder=Find...>
<input id=replaceTerm placeholder="Replace with...">
<button id=findNextBtn title="Find Next"><i class="fas fa-arrow-down"></i></button>
<button id=findPrevBtn title="Find Previous"><i class="fas fa-arrow-up"></i></button>
<button id=replaceAllBtn title="Replace All"><i class="fas fa-redo"></i> All</button>
<button class=close-btn id=closeSearchBtn><i class="fas fa-times"></i></button>
</div>
</div>
</div>
<div id=formattingToolbar class=formatting-toolbar>
<button data-format=bold><i class="fas fa-bold"></i></button>
<button data-format=italic><i class="fas fa-italic"></i></button>
<button data-format=h1>H1</button>
<button data-format=h2>H2</button>
<button data-format=h3>H3</button>
<button data-format=blockquote><i class="fas fa-quote-right"></i></button>
<button data-format=code><i class="fas fa-code"></i></button>
<button data-format=link><i class="fas fa-link"></i></button>
<input type=color id=textColorPicker value=#f0f6fc>
</div>
<div id=confirmationModal class=modal>
<div class=modal-content>
<p id=modalMessage>Are you sure?</p>
<div class=modal-buttons>
<button class=confirm-btn id=modalConfirmBtn>Confirm</button>
<button class=cancel-btn id=modalCancelBtn>Cancel</button>
</div>
</div>
</div>
<script>class LiveMarkdownEditor{constructor(){this.drafts=[],this.currentDraftId=null,this.autoSaveTimer=null,this.localStorageKey="markdownEditorDrafts",this.searchResults=[],this.currentSearchIndex=-1,this.initElements(),this.bindEvents(),this.loadSettingsFromLocalStorage(),this.applySettings(),this.loadDraftsFromLocalStorage(),0===this.drafts.length?this.createNewDraft():this.loadDraft(this.drafts[0].id)}initElements(){this.editor=document.getElementById("editor"),this.optionsPanel=document.getElementById("optionsPanel"),this.draftsList=document.getElementById("draftsList"),this.draftTitle=document.getElementById("draftTitle"),this.zoomSlider=document.getElementById("zoomSlider"),this.zoomValue=document.getElementById("zoomValue"),this.optionsBtn=document.getElementById("optionsBtn"),this.formattingToolbar=document.getElementById("formattingToolbar"),this.formatButtons=this.formattingToolbar.querySelectorAll("button[data-format]"),this.textColorPicker=document.getElementById("textColorPicker"),this.confirmationModal=document.getElementById("confirmationModal"),this.modalMessage=document.getElementById("modalMessage"),this.modalConfirmBtn=document.getElementById("modalConfirmBtn"),this.modalCancelBtn=document.getElementById("modalCancelBtn"),this.toggleOpenDyslexic=document.getElementById("toggleOpenDyslexic"),this.toggleLightMode=document.getElementById("toggleLightMode"),this.downloadMarkdownBtn=document.getElementById("downloadMarkdown"),this.downloadHTMLBtn=document.getElementById("downloadHTML"),this.downloadTXTBtn=document.getElementById("downloadTXT"),this.searchReplaceBar=document.getElementById("searchReplaceBar"),this.searchTermInput=document.getElementById("searchTerm"),this.replaceTermInput=document.getElementById("replaceTerm"),this.findNextBtn=document.getElementById("findNextBtn"),this.findPrevBtn=document.getElementById("findPrevBtn"),this.replaceAllBtn=document.getElementById("replaceAllBtn"),this.closeSearchBtn=document.getElementById("closeSearchBtn"),this.fileInput=document.getElementById("fileInput"),this.importFileBtn=document.getElementById("importFileBtn")}bindEvents(){this.optionsBtn.addEventListener("click",(t=>{t.stopPropagation();const e=this.optionsPanel.classList.toggle("open");this.optionsBtn.innerHTML=e?'<i class="fas fa-times"></i>':'<i class="fas fa-cog"></i>'})),this.zoomSlider.addEventListener("input",(t=>{const e=t.target.value;this.editor.style.fontSize=e/100*16+"px",this.zoomValue.textContent=`${e}%`})),document.getElementById("newDraft").addEventListener("click",(()=>{this.createNewDraft()})),this.editor.addEventListener("input",(()=>{this.scheduleAutoSave(),this.clearSearchResults()})),this.editor.addEventListener("mouseup",this.handleSelectionChange.bind(this)),this.editor.addEventListener("keyup",this.handleSelectionChange.bind(this)),document.addEventListener("mousedown",(t=>{this.formattingToolbar.contains(t.target)||this.editor.contains(t.target)||this.searchReplaceBar.contains(t.target)||this.hideToolbar()})),this.draftTitle.addEventListener("input",(()=>{this.scheduleAutoSave()})),document.addEventListener("click",(t=>{this.optionsPanel.contains(t.target)||this.optionsBtn.contains(t.target)||(this.optionsPanel.classList.remove("open"),this.optionsBtn.innerHTML='<i class="fas fa-cog"></i>')})),this.formatButtons.forEach((t=>{t.addEventListener("click",(t=>{t.preventDefault();const e=t.currentTarget.dataset.format;this.applyFormat(e),this.hideToolbar()}))})),this.editor.addEventListener("keydown",(t=>{(t.ctrlKey||t.metaKey)&&("b"===t.key||"i"===t.key||"u"===t.key||"`"===t.key?t.preventDefault():"f"===t.key&&(t.preventDefault(),this.toggleSearchReplaceBar(!0)))})),this.textColorPicker.addEventListener("input",(t=>{const e=t.target.value;this.applyColor(e),this.scheduleAutoSave(),this.hideToolbar()})),this.toggleOpenDyslexic.addEventListener("change",(t=>{this.settings.useOpenDyslexic=t.target.checked,this.applySettings(),this.saveSettingsToLocalStorage()})),this.toggleLightMode.addEventListener("change",(t=>{this.settings.lightMode=t.target.checked,this.applySettings(),this.saveSettingsToLocalStorage()})),this.downloadMarkdownBtn.addEventListener("click",(()=>this.downloadContent("md"))),this.downloadHTMLBtn.addEventListener("click",(()=>this.downloadContent("html"))),this.downloadTXTBtn.addEventListener("click",(()=>this.downloadContent("txt"))),this.searchTermInput.addEventListener("input",this.findText.bind(this)),this.findNextBtn.addEventListener("click",(()=>this.navigateToSearchResult(1))),this.findPrevBtn.addEventListener("click",(()=>this.navigateToSearchResult(-1))),this.replaceAllBtn.addEventListener("click",this.replaceAll.bind(this)),this.closeSearchBtn.addEventListener("click",this.toggleSearchReplaceBar.bind(this,!1)),this.editor.addEventListener("keydown",(t=>{"Escape"===t.key&&this.searchReplaceBar.classList.contains("open")&&this.toggleSearchReplaceBar(!1)})),this.importFileBtn.addEventListener("click",(()=>this.fileInput.click())),this.fileInput.addEventListener("change",this.importFile.bind(this))}handleSelectionChange(){const t=window.getSelection();if(!t.isCollapsed&&this.editor.contains(t.focusNode)&&this.editor.contains(t.anchorNode)){const e=t.getRangeAt(0).getBoundingClientRect();let n=e.top+window.scrollY-this.formattingToolbar.offsetHeight-10,o=e.left+window.scrollX+e.width/2-this.formattingToolbar.offsetWidth/2;n<window.scrollY+10&&(n=e.bottom+window.scrollY+10),o<window.scrollX+10&&(o=window.scrollX+10),o+this.formattingToolbar.offsetWidth>window.innerWidth-10&&(o=window.innerWidth-this.formattingToolbar.offsetWidth-10),this.formattingToolbar.style.display="flex",this.formattingToolbar.style.left=`${o}px`,this.formattingToolbar.style.top=`${n}px`}else this.hideToolbar()}hideToolbar(){this.formattingToolbar.style.display="none"}applyFormat(t){switch(this.editor.focus(),this.clearSearchResults(),t){case"bold":document.execCommand("bold",!1,null);break;case"italic":document.execCommand("italic",!1,null);break;case"h1":document.execCommand("formatBlock",!1,"<h1>");break;case"h2":document.execCommand("formatBlock",!1,"<h2>");break;case"h3":document.execCommand("formatBlock",!1,"<h3>");break;case"blockquote":document.execCommand("formatBlock",!1,"<blockquote>");break;case"code":const e=window.getSelection();if(!e.rangeCount)break;const n=e.getRangeAt(0);const o=n.commonAncestorContainer.closest("pre");if(o){document.execCommand("formatBlock",!1,"p");const t=window.getSelection();if(t.rangeCount){const e=t.getRangeAt(0).commonAncestorContainer.closest("code");if(e&&e.parentNode===o){const t=document.createDocumentFragment();for(;e.firstChild;)t.appendChild(e.firstChild);e.parentNode.replaceChild(t,e)}}}else{const t=n.extractContents(),o=document.createElement("pre"),s=document.createElement("code");s.appendChild(t),o.appendChild(s),n.insertNode(o),n.selectNodeContents(s),e.removeAllRanges(),e.addRange(n)}break;case"link":const s=prompt("Enter the URL:","https://");s&&document.execCommand("createLink",!1,s);break;default:console.warn("Unknown format command:",t)}this.scheduleAutoSave()}applyColor(t){this.editor.focus();const e=window.getSelection();if(!e.rangeCount)return;const n=e.getRangeAt(0),o=n.extractContents();if(""===o.textContent.trim())return void document.execCommand("foreColor",!1,t);const s=document.createElement("span");s.style.color=t,s.appendChild(o),n.insertNode(s),e.removeAllRanges(),e.addRange(n)}placeCursorAtEnd(){const t=window.getSelection(),e=document.createRange();this.editor.lastChild?this.editor.lastChild.nodeType===Node.TEXT_NODE?e.setStart(this.editor.lastChild,this.editor.lastChild.textContent.length):e.setStartAfter(this.editor.lastChild):e.setStart(this.editor,0),e.collapse(!0),t.removeAllRanges(),t.addRange(e)}scheduleAutoSave(){clearTimeout(this.autoSaveTimer),this.autoSaveTimer=setTimeout((()=>{this.saveDraft(),this.saveDraftsToLocalStorage()}),1e3)}createNewDraft(){this.saveDraft();const t={id:Date.now(),title:"",content:"",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};this.drafts.unshift(t),this.loadDraft(t.id),this.renderDrafts(),this.saveDraftsToLocalStorage()}loadDraft(t){const e=this.drafts.find((e=>e.id===t));e&&(this.currentDraftId=t,this.draftTitle.value=e.title,this.editor.innerHTML=this.convertCustomColorSyntaxToHtml(e.content),this.renderDrafts(),this.placeCursorAtEnd(),this.clearSearchResults())}saveDraft(){if(!this.currentDraftId)return;const t=this.drafts.find((t=>t.id===this.currentDraftId));if(t){const e=this.editor.innerHTML,n=this.convertHtmlToCustomColorSyntax(e),o=this.editor.textContent||"";t.title=this.draftTitle.value||this.generateTitleFromContent(o),t.content=n,t.updatedAt=(new Date).toISOString(),this.renderDrafts()}}convertHtmlToCustomColorSyntax(t){const e=document.createElement("div");return e.innerHTML=t,e.querySelectorAll('span[style*="color:"]').forEach((t=>{const e=t.style.color;let n="";const o=e.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);if(o){const t=t=>{const e=parseInt(t).toString(16);return 1===e.length?"0"+e:e};n=`#${t(o[1])}${t(o[2])}${t(o[3])}`}else{if(!e.startsWith("#"))return void console.warn(`Could not convert color '${e}' to hex for custom syntax.`);n=e}const s=`<${n}>${t.innerHTML}</>`,i=document.createTextNode(s);t.parentNode.replaceChild(i,t)})),e.innerHTML}convertCustomColorSyntaxToHtml(t){return t.replace(/<#([0-9a-fA-F]{3,6})>(.*?)<\/>/gs,((t,e,n)=>`<span style="color: #${e}">${n}</span>`))}generateTitleFromContent(t){if(!t.trim())return"Untitled Draft";const e=t.split("\n")[0]||"";return e.substring(0,20)+(e.length>20?"...":"")||"Untitled Draft"}showConfirmationModal(t){return new Promise((e=>{this.modalMessage.textContent=t,this.confirmationModal.style.display="flex";const n=()=>{this.confirmationModal.style.display="none",this.modalConfirmBtn.removeEventListener("click",n),this.modalCancelBtn.removeEventListener("click",o),e(!0)},o=()=>{this.confirmationModal.style.display="none",this.modalConfirmBtn.removeEventListener("click",n),this.modalCancelBtn.removeEventListener("click",o),e(!1)};this.modalConfirmBtn.addEventListener("click",n),this.modalCancelBtn.addEventListener("click",o)}))}async deleteDraft(t){await this.showConfirmationModal("Are you sure you want to delete this draft?")&&(this.drafts=this.drafts.filter((e=>e.id!==t)),this.currentDraftId===t&&(this.drafts.length>0?this.loadDraft(this.drafts[0].id):this.createNewDraft()),this.renderDrafts(),this.saveDraftsToLocalStorage())}renderDrafts(){this.draftsList.innerHTML="",0!==this.drafts.length?(this.drafts.forEach((t=>{const e=document.createElement("div");e.className="draft-item "+(t.id===this.currentDraftId?"active":""),e.draggable=!0,e.dataset.id=t.id;const n=this.convertCustomColorSyntaxToHtml(t.content),o=document.createElement("div");o.innerHTML=n;const s=o.textContent||o.innerText||"",i=t.title||this.generateTitleFromContent(s),r=s.substring(0,50)+(s.length>50?"...":"");e.innerHTML=`\n                <div class="draft-info">\n                    <div class="draft-title">${i}</div>\n                    <div class="draft-preview">${r||"Empty draft"}</div>\n                </div>\n                <div class="draft-actions">\n                    <button class="draft-btn" data-action="delete" data-id="${t.id}">Delete</button>\n                </div>\n            `,e.querySelector(".draft-info").addEventListener("click",(e=>{e.stopPropagation(),this.loadDraft(t.id)}));e.querySelector('[data-action="delete"]').addEventListener("click",(t=>{t.stopPropagation(),this.deleteDraft(parseInt(t.target.dataset.id))})),e.addEventListener("dragstart",(n=>{n.dataTransfer.setData("text/plain",t.id),e.classList.add("dragging")})),e.addEventListener("dragend",(()=>{e.classList.remove("dragging")})),this.draftsList.appendChild(e)})),this.draftsList.addEventListener("dragover",(t=>{t.preventDefault();const e=document.querySelector(".draft-item.dragging");if(e){const n=this.getDragAfterElement(this.draftsList,t.clientY);null==n?this.draftsList.appendChild(e):this.draftsList.insertBefore(e,n)}})),this.draftsList.addEventListener("drop",(t=>{t.preventDefault();const e=parseInt(t.dataTransfer.getData("text/plain"));if(this.drafts.find((t=>t.id===e))){const t=Array.from(this.draftsList.children).map((t=>parseInt(t.dataset.id))),e=[];for(const n of t){const t=this.drafts.find((t=>t.id===n));t&&e.push(t)}this.drafts=e,this.saveDraftsToLocalStorage()}}))):this.draftsList.innerHTML='<div style="color: var(--text-secondary); text-align: center; padding: 2rem;">No drafts</div>'}getDragAfterElement(t,e){return[...t.querySelectorAll(".draft-item:not(.dragging)")].reduce(((t,n)=>{const o=n.getBoundingClientRect(),s=e-o.top-o.height/2;return s<0&&s>t.offset?{offset:s,element:n}:t}),{offset:-1/0}).element}saveDraftsToLocalStorage(){try{const t=this.drafts.map((t=>({...t,createdAt:t.createdAt instanceof Date?t.createdAt.toISOString():t.createdAt,updatedAt:t.updatedAt instanceof Date?t.updatedAt.toISOString():t.updatedAt})));localStorage.setItem(this.localStorageKey,JSON.stringify(t)),console.log("Drafts saved to localStorage ✅")}catch(t){console.error("Failed to save drafts to localStorage:",t)}}loadDraftsFromLocalStorage(){try{const t=localStorage.getItem(this.localStorageKey);t&&(this.drafts=JSON.parse(t).map((t=>({...t,createdAt:new Date(t.createdAt),updatedAt:new Date(t.updatedAt)}))),this.drafts.forEach((t=>{t.content=this.convertCustomColorSyntaxToHtml(t.content)})),console.log("Drafts loaded from localStorage ✨"))}catch(t){console.error("Failed to load drafts from localStorage:",t)}}settings={useOpenDyslexic:!0,lightMode:!1};saveSettingsToLocalStorage(){try{localStorage.setItem("markdownEditorSettings",JSON.stringify(this.settings)),console.log("Settings saved to localStorage ⚙️")}catch(t){console.error("Couldn't save settings to localStorage:",t)}}loadSettingsFromLocalStorage(){try{const t=localStorage.getItem("markdownEditorSettings");t&&(this.settings={...this.settings,...JSON.parse(t)},console.log("Settings loaded from localStorage 🚀"))}catch(t){console.error("Failed to load settings from localStorage:",t)}}applySettings(){this.settings.useOpenDyslexic?(document.body.classList.add("use-opendyslexic"),this.editor.style.fontFamily="'OpenDyslexic', Arial, sans-serif"):(document.body.classList.remove("use-opendyslexic"),this.editor.style.fontFamily="Arial, sans-serif"),this.toggleOpenDyslexic.checked=this.settings.useOpenDyslexic,this.settings.lightMode?document.body.classList.add("light-mode"):document.body.classList.remove("light-mode"),this.toggleLightMode.checked=this.settings.lightMode}downloadContent(t){const e=this.drafts.find((t=>t.id===this.currentDraftId));if(!e)return void this.showConfirmationModal("No draft selected to download.");let n=(e.title||"untitled").replace(/[^a-z0-9]/gi,"_").toLowerCase(),o="",s="";const i=this.editor.innerHTML;switch(t){case"md":o=this.convertHtmlToMarkdown(i),s="text/markdown",n+=".md";break;case"html":o=i,s="text/html",n+=".html";break;case"txt":const e=document.createElement("div");e.innerHTML=i,o=e.textContent||e.innerText||"",o=o.replace(/<#([0-9a-fA-F]{3,6})>(.*?)<\/>/gs,"$2"),s="text/plain",n+=".txt";break;default:return void console.warn("Unsupported download format:",t)}const r=new Blob([o],{type:s}),a=document.createElement("a");a.href=URL.createObjectURL(r),a.download=n,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(a.href)}convertHtmlToMarkdown(t){let e=document.createElement("div");e.innerHTML=t,e.querySelectorAll('span[style*="color:"]').forEach((t=>{const e=document.createTextNode(t.textContent);t.parentNode.replaceChild(e,t)}));let n=e.innerHTML;return n=n.replace(/<h1>(.*?)<\/h1>/g,"# $1\n"),n=n.replace(/<h2>(.*?)<\/h2>/g,"## $1\n"),n=n.replace(/<h3>(.*?)<\/h3>/g,"### $1\n"),n=n.replace(/<h4>(.*?)<\/h4>/g,"#### $1\n"),n=n.replace(/<h5>(.*?)<\/h5>/g,"##### $1\n"),n=n.replace(/<h6>(.*?)<\/h6>/g,"###### $1\n"),n=n.replace(/<strong>(.*?)<\/strong>/g,"**$1**"),n=n.replace(/<b>(.*?)<\/b>/g,"**$1**"),n=n.replace(/<em>(.*?)<\/em>/g,"*$1*"),n=n.replace(/<i>(.*?)<\/i>/g,"*$1*"),n=n.replace(/<blockquote>([\s\S]*?)<\/blockquote>/g,((t,e)=>e.split("\n").map((t=>`> ${t.trim()}`)).join("\n").trim()+"\n\n")),n=n.replace(/<pre><code>([\s\S]*?)<\/code><\/pre>/g,"```\n$1\n```\n"),n=n.replace(/<code>(.*?)<\/code>/g,"`$1`"),n=n.replace(/<a href="(.*?)">(.*?)<\/a>/g,"[$2]($1)"),n=n.replace(/<ul>([\s\S]*?)<\/ul>/gs,((t,e)=>e.replace(/<li>([\s\S]*?)<\/li>/g,((t,e)=>{const n=e.trim().split("\n");return`- ${n[0]}\n`+n.slice(1).map((t=>`  ${t}`)).join("\n")+"\n"})))),n=n.replace(/<ol>([\s\S]*?)<\/ol>/gs,((t,e)=>{let n=1;return e.replace(/<li>([\s\S]*?)<\/li>/g,((t,e)=>{const o=e.trim().split("\n");return`${n++}. ${o[0]}\n`+o.slice(1).map((t=>`   ${t}`)).join("\n")+"\n"}))})),n=n.replace(/<br\s*\/?>/g,"\n"),n=n.replace(/\n{3,}/g,"\n\n").trim(),n}toggleSearchReplaceBar(t){"boolean"==typeof t?t?(this.searchReplaceBar.classList.add("open"),this.searchTermInput.focus(),this.findText()):(this.searchReplaceBar.classList.remove("open"),this.clearSearchResults()):(this.searchReplaceBar.classList.toggle("open"),this.searchReplaceBar.classList.contains("open")?(this.searchTermInput.focus(),this.findText()):this.clearSearchResults())}findText(){this.clearSearchResults();const t=this.searchTermInput.value.trim();if(""===t)return;const e=this.editor.innerHTML,n=document.createElement("div");n.innerHTML=e;let o=[],s=0;const i=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,null,!1);let r;for(;r=i.nextNode();)o.push({node:r,start:s,end:s+r.nodeValue.length}),s+=r.nodeValue.length;const a=n.textContent,l=new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");let d;for(this.searchResults=[];null!==(d=l.exec(a));)this.searchResults.push({start:d.index,end:d.index+d[0].length});this.searchResults.length>0?(this.highlightSearchResults(),this.currentSearchIndex=0,this.scrollToSearchResult(this.currentSearchIndex)):this.currentSearchIndex=-1}highlightSearchResults(){this.clearHighlights();const t=this.editor.innerHTML,e=document.createElement("div");e.innerHTML=t,this.searchResults.forEach(((t,n)=>{const o=document.createRange();let s=0,i=null,r=null,a=0,l=0;const d=document.createTreeWalker(e,NodeFilter.SHOW_TEXT);for(;d.nextNode();){const e=d.currentNode,n=e.nodeValue.length;if(null===i&&t.start>=s&&t.start<s+n&&(i=e,a=t.start-s),null===r&&t.end>s&&t.end<=s+n&&(r=e,l=t.end-s),i&&r)break;s+=n}if(i&&r)try{o.setStart(i,a),o.setEnd(r,l);const t=document.createElement("span");t.className="highlight",t.dataset.searchIndex=n,o.surroundContents(t)}catch(e){console.warn("Could not highlight range:",e,t,i,r)}})),this.editor.innerHTML=e.innerHTML,this.editor.normalize()}clearHighlights(){this.editor.querySelectorAll(".highlight").forEach((t=>{const e=t.parentNode;for(;t.firstChild;)e.insertBefore(t.firstChild,t);e.removeChild(t),e.normalize()}))}clearSearchResults(){this.clearHighlights(),this.searchResults=[],this.currentSearchIndex=-1}navigateToSearchResult(t){0!==this.searchResults.length&&(this.currentSearchIndex+=t,this.currentSearchIndex>=this.searchResults.length?this.currentSearchIndex=0:this.currentSearchIndex<0&&(this.currentSearchIndex=this.searchResults.length-1),this.scrollToSearchResult(this.currentSearchIndex),this.updateActiveHighlight(this.currentSearchIndex))}scrollToSearchResult(t){const e=this.editor.querySelector(`.highlight[data-search-index="${t}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"center"})}updateActiveHighlight(t){this.editor.querySelectorAll(".highlight").forEach(((e,n)=>{e.style.backgroundColor=n===t?"rgba(255, 165, 0, 0.7)":"rgba(255, 255, 0, 0.5)"}))}replaceAll(){const t=this.searchTermInput.value,e=this.replaceTermInput.value;if(!t)return void this.showConfirmationModal("Please enter a term to find.");this.editor.innerHTML;const n=new RegExp(t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"gi");this.clearHighlights();const o=document.createElement("div");o.innerHTML=this.editor.innerHTML;const s=t=>{if(t.nodeType===Node.TEXT_NODE)t.nodeValue=t.nodeValue.replace(n,e);else if(t.nodeType===Node.ELEMENT_NODE){if("script"===t.tagName.toLowerCase()||"style"===t.tagName.toLowerCase())return;for(let e=0;e<t.childNodes.length;e++)s(t.childNodes[e])}};s(o),this.editor.innerHTML=o.innerHTML,this.scheduleAutoSave(),this.findText(),this.showConfirmationModal(`All occurrences of "${t}" replaced with "${e}".`)}importFile(t){const e=t.target.files[0];if(!e)return;const n=new FileReader;n.onload=n=>{const o=n.target.result,s=e.name.split(".").pop().toLowerCase();let i=o;if("md"===s||"txt"===s){const t=document.createElement("pre");t.textContent=o,i=t.innerHTML,i=this.convertCustomColorSyntaxToHtml(i)}else"html"===s&&(i=o,i=this.convertCustomColorSyntaxToHtml(i));const r=e.name.replace(/\.[^/.]+$/,""),a={id:Date.now(),title:r,content:i,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString()};this.drafts.unshift(a),this.loadDraft(a.id),this.renderDrafts(),this.saveDraftsToLocalStorage(),this.showConfirmationModal(`File "${e.name}" imported successfully!`),t.target.value=""},n.onerror=()=>{this.showConfirmationModal("Error reading file.")},n.readAsText(e)}}document.addEventListener("DOMContentLoaded",(()=>{new LiveMarkdownEditor}))</script>
</body>
</html>
